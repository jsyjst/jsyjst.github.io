<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">




















  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext">
  






<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false,"dimmer":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="本文Glide源码基于4.9,版本下载地址如下：Glide 4.9  前言 由于Glide源码真的很复杂，因此本文只分析和贴出与图片加载流程相关的功能以及代码。另外本文Glide源码基于4.9,与3.x的源码还是存在差异的，但是整体流程变化不大。  对于Glide这个强大的Android图片加载开源框架，相信大家并不陌生吧，反正笔者的话，正常项目中用的图片加载框架大多数都是它，因为用起来真的很方">
<meta name="keywords" content="拆轮子系列">
<meta property="og:type" content="article">
<meta property="og:title" content="Glide 4.9源码解析-图片加载流程">
<meta property="og:url" content="http://yoursite.com/2019/10/18/Glide-4-9源码解析-图片加载流程/index.html">
<meta property="og:site_name" content="健策的博客">
<meta property="og:description" content="本文Glide源码基于4.9,版本下载地址如下：Glide 4.9  前言 由于Glide源码真的很复杂，因此本文只分析和贴出与图片加载流程相关的功能以及代码。另外本文Glide源码基于4.9,与3.x的源码还是存在差异的，但是整体流程变化不大。  对于Glide这个强大的Android图片加载开源框架，相信大家并不陌生吧，反正笔者的话，正常项目中用的图片加载框架大多数都是它，因为用起来真的很方">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/2019/10/18/Glide-4-9源码解析-图片加载流程/with.png">
<meta property="og:image" content="http://yoursite.com/2019/10/18/Glide-4-9源码解析-图片加载流程/load.png">
<meta property="og:image" content="http://yoursite.com/2019/10/18/Glide-4-9源码解析-图片加载流程/into.png">
<meta property="og:updated_time" content="2019-10-18T08:41:33.686Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Glide 4.9源码解析-图片加载流程">
<meta name="twitter:description" content="本文Glide源码基于4.9,版本下载地址如下：Glide 4.9  前言 由于Glide源码真的很复杂，因此本文只分析和贴出与图片加载流程相关的功能以及代码。另外本文Glide源码基于4.9,与3.x的源码还是存在差异的，但是整体流程变化不大。  对于Glide这个强大的Android图片加载开源框架，相信大家并不陌生吧，反正笔者的话，正常项目中用的图片加载框架大多数都是它，因为用起来真的很方">
<meta name="twitter:image" content="http://yoursite.com/2019/10/18/Glide-4-9源码解析-图片加载流程/with.png">






  <link rel="canonical" href="http://yoursite.com/2019/10/18/Glide-4-9源码解析-图片加载流程/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Glide 4.9源码解析-图片加载流程 | 健策的博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">健策的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">人生就像一盒巧克力，你永远不知道下一颗是什么味道！</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/18/Glide-4-9源码解析-图片加载流程/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="袁健策">
      <meta itemprop="description" content="在校大学生，Android小白，正在努力学习中！">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="健策的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Glide 4.9源码解析-图片加载流程

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-10-18 16:38:03 / 修改时间：16:41:33" itemprop="dateCreated datePublished" datetime="2019-10-18T16:38:03+08:00">2019-10-18</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/拆轮子系列/" itemprop="url" rel="index"><span itemprop="name">拆轮子系列</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>本文Glide源码基于4.9,版本下载地址如下：<a href="https://github.com/bumptech/glide/archive/v4.9.0.zip" target="_blank" rel="noopener">Glide 4.9</a></p>
</blockquote>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><blockquote>
<p>由于Glide源码真的很复杂，因此本文只分析和贴出与图片加载流程相关的功能以及代码。另外本文Glide源码基于4.9,与3.x的源码还是存在差异的，但是整体流程变化不大。</p>
</blockquote>
<p>对于Glide这个强大的Android图片加载开源框架，相信大家并不陌生吧，反正笔者的话，正常项目中用的图片加载框架大多数都是它，因为用起来真的很方便快捷，用起来便捷，但真的说明它的源码就是那么简单吗？所以今天想揭开Glide的神秘面纱，从源码来分析一下Glide的图片加载流程。</p>
<p>在多数情况下，我们想要在界面加载并展示一张图片只需要一行代码就能实现了，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Glide.with(<span class="keyword">this</span>).load(url).into(imageView);</span><br></pre></td></tr></table></figure>
<p>所以我们对Glide图片加载流程的源码分析可以分为三部曲：</p>
<ul>
<li>with</li>
<li>load</li>
<li>into</li>
</ul>
<p>接下来就让我们一起来弹奏这三部曲！</p>
<h1 id="一、with"><a href="#一、with" class="headerlink" title="一、with"></a>一、with</h1><h2 id="1-作用"><a href="#1-作用" class="headerlink" title="1. 作用"></a>1. 作用</h2><ol>
<li>得到RequestManager对象</li>
<li>预先创建好对图片进行一系列操作（加载，编解码，转码）的对象，并添加到Glide的注册表registry中</li>
<li>将Glide加载图片的生命周期与Appliction/Activity/Fragment进行绑定</li>
</ol>
<h2 id="2-流程"><a href="#2-流程" class="headerlink" title="2. 流程"></a>2. 流程</h2><h3 id="2-1-时序图"><a href="#2-1-时序图" class="headerlink" title="2.1 时序图"></a>2.1 时序图</h3><p><img src="/2019/10/18/Glide-4-9源码解析-图片加载流程/with.png" alt="1571208748325"></p>
<p>首先，从使用中我们知道，第一部曲中我们先调用的是Glide的with方法，所以先来看看这个方法</p>
<blockquote>
<p>Glide#with</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Application类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//getRetriever会返回RequestManagerRetriever的单例对象</span></span><br><span class="line">	<span class="comment">//RequestManagerRetriever的get会返回RequestManager对象并绑定图片加载的生命周期</span></span><br><span class="line">  <span class="keyword">return</span> getRetriever(context).get(context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 非Application类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(@NonNull Activity activity)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//跟Application类型一样会调用RequestManagerRetriever的get获取RequestManager对象</span></span><br><span class="line">	<span class="comment">//不过需注意在这里传递的参数为Activity</span></span><br><span class="line">  <span class="keyword">return</span> getRetriever(activity).get(activity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(@NonNull FragmentActivity activity)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getRetriever(activity).get(activity);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>可以发现，with方法是Glide类中的一组静态方法，在Glide中有很多的重载方法，可以传入Context,Activity,Fragment等，然后with里面的实现很简单，就一句代码，看返回类型就知道其功能是干嘛，就是返回一个RequestManager对象。那么具体是如何来得到这个对象呢，让我们来看看！</p>
<h3 id="2-2-获取RequestManagerRetriever对象"><a href="#2-2-获取RequestManagerRetriever对象" class="headerlink" title="2.2 获取RequestManagerRetriever对象"></a>2.2 获取RequestManagerRetriever对象</h3><p>在返回RequestManager对象对象前首先会返回RequestManagerRetriever对象，不管with的参数是什么，调用的都是getRetriever方法，而且getRetriever并没有重载方法，所以获取RequestManagerRetriever对象的步骤是一样的，让我们来追踪一下到底是如何获取到这个RequestManagerRetriever对象的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> RequestManagerRetriever <span class="title">getRetriever</span><span class="params">(@Nullable Context context)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"><span class="comment">//1.调用Glide.get获取到Glide的对象，Glide对象中封装了RequestManagerRetriever对象</span></span><br><span class="line"><span class="comment">//2.通过Glide的getRequestManagerRetriever()获取到RequestManagerRetriever对象</span></span><br><span class="line">   <span class="keyword">return</span> Glide.get(context).getRequestManagerRetriever();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Glide <span class="title">get</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (glide == <span class="keyword">null</span>) &#123;</span><br><span class="line">     <span class="keyword">synchronized</span> (Glide.class) &#123;</span><br><span class="line">       <span class="keyword">if</span> (glide == <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="comment">//重点关注  </span></span><br><span class="line">         checkAndInitializeGlide(context);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> glide;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkAndInitializeGlide</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (isInitializing) &#123;</span><br><span class="line">  <span class="comment">//如果同时进行两次初始化会抛出该异常		</span></span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"You cannot call Glide.get() in registerComponents(),"</span></span><br><span class="line">         + <span class="string">" use the provided Glide instance instead"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   isInitializing = <span class="keyword">true</span>;</span><br><span class="line"><span class="comment">//进行初始化操作</span></span><br><span class="line">   initializeGlide(context);</span><br><span class="line">   isInitializing = <span class="keyword">false</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initializeGlide</span><span class="params">(@NonNull Context context, @NonNull GlideBuilder builder)</span> </span>&#123;</span><br><span class="line">     ....</span><br><span class="line">     	<span class="comment">//构造Glide的实体对象,此时的builder为GlideBuilder</span></span><br><span class="line">       Glide glide = builder.build(applicationContext);   </span><br><span class="line">     ....</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>首先getRetriever方法看起来好像跟with里面的代码很类似，其实主要做了两件事：</p>
<ul>
<li>通过Glide.get获取到Glide的对象</li>
<li>调用Glide的getRequestManagerRetriever()获取到RequestManagerRetriever对象</li>
</ul>
<p>在Glide的get方法就是简单标准的单例实现。在initializeGlide中会通过GlideBuilder的build来构造Glide的实体对象,这个Glide的构造很重要，因此我们来看看GlideBuilder的build方法是如何来构建Glide对象的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="function">Glide <span class="title">build</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">    ......  </span><br><span class="line">	<span class="comment">//构建管理线程池与缓存的执行引擎</span></span><br><span class="line">    <span class="keyword">if</span> (engine == <span class="keyword">null</span>) &#123;</span><br><span class="line">      engine =</span><br><span class="line">          <span class="keyword">new</span> Engine(</span><br><span class="line">              memoryCache,</span><br><span class="line">              diskCacheFactory,</span><br><span class="line">              diskCacheExecutor,</span><br><span class="line">              sourceExecutor,</span><br><span class="line">              GlideExecutor.newUnlimitedSourceExecutor(),</span><br><span class="line">              GlideExecutor.newAnimationExecutor(),</span><br><span class="line">              isActiveResourceRetentionAllowed);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//构建了一个RequestManagerRetriever对象</span></span><br><span class="line">    RequestManagerRetriever requestManagerRetriever =</span><br><span class="line">        <span class="keyword">new</span> RequestManagerRetriever(requestManagerFactory);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//构建Glide对象，并将上面的众多线程池和RequestManagerRetriever对象封装进去</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Glide(</span><br><span class="line">        context,</span><br><span class="line">        engine,</span><br><span class="line">        memoryCache,</span><br><span class="line">        bitmapPool,</span><br><span class="line">        arrayPool,</span><br><span class="line">        requestManagerRetriever,</span><br><span class="line">        connectivityMonitorFactory,</span><br><span class="line">        logLevel,</span><br><span class="line">        defaultRequestOptions.lock(),</span><br><span class="line">        defaultTransitionOptions,</span><br><span class="line">        defaultRequestListeners,</span><br><span class="line">        isLoggingRequestOriginsEnabled);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Glide</span> <span class="keyword">implements</span> <span class="title">ComponentCallbacks2</span> </span>&#123;</span><br><span class="line">      Glide(</span><br><span class="line">      <span class="meta">@NonNull</span> Context context,</span><br><span class="line">      <span class="meta">@NonNull</span> Engine engine,</span><br><span class="line">      <span class="meta">@NonNull</span> MemoryCache memoryCache,</span><br><span class="line">      <span class="meta">@NonNull</span> BitmapPool bitmapPool,</span><br><span class="line">      <span class="meta">@NonNull</span> ArrayPool arrayPool,</span><br><span class="line">      <span class="meta">@NonNull</span> RequestManagerRetriever requestManagerRetriever,</span><br><span class="line">      <span class="meta">@NonNull</span> ConnectivityMonitorFactory connectivityMonitorFactory,</span><br><span class="line">      <span class="keyword">int</span> logLevel,</span><br><span class="line">      <span class="meta">@NonNull</span> RequestOptions defaultRequestOptions,</span><br><span class="line">      <span class="meta">@NonNull</span> Map&lt;Class&lt;?&gt;, TransitionOptions&lt;?, ?&gt;&gt; defaultTransitionOptions,</span><br><span class="line">      <span class="meta">@NonNull</span> List&lt;RequestListener&lt;Object&gt;&gt; defaultRequestListeners,</span><br><span class="line">      <span class="keyword">boolean</span> isLoggingRequestOriginsEnabled) &#123;</span><br><span class="line">          ...</span><br><span class="line">          <span class="comment">//将RequestManagerRetriever对象赋值到成员变量中</span></span><br><span class="line">          <span class="keyword">this</span>.requestManagerRetriever = requestManagerRetriever;</span><br><span class="line">          ....</span><br><span class="line">          <span class="comment">//解码器</span></span><br><span class="line">          StreamBitmapDecoder streamBitmapDecoder = <span class="keyword">new</span> StreamBitmapDecoder(downsampler, arrayPool);    </span><br><span class="line">          <span class="comment">//添加到注册表中    </span></span><br><span class="line">          registry</span><br><span class="line">              .append(Registry.BUCKET_BITMAP, InputStream.class, Bitmap.class, streamBitmapDecoder)</span><br><span class="line">              ....</span><br><span class="line">              <span class="comment">/* Models */</span></span><br><span class="line">              <span class="comment">//重点关注InputStreamRewinder</span></span><br><span class="line">              .register(<span class="keyword">new</span> InputStreamRewinder.Factory(arrayPool))</span><br><span class="line">              ....</span><br><span class="line">              <span class="comment">//重点关注StringLoader.StreamFactory()</span></span><br><span class="line">              .append(String.class, InputStream.class, <span class="keyword">new</span> StringLoader.StreamFactory())</span><br><span class="line">              .... </span><br><span class="line">              <span class="comment">//重点关注HttpUriLoader.Factory()</span></span><br><span class="line">        	 .append(Uri.class, InputStream.class, <span class="keyword">new</span> HttpUriLoader.Factory())</span><br><span class="line">              ....</span><br><span class="line">              <span class="comment">//重点关注HttpGlideUrlLoader</span></span><br><span class="line">              .append(GlideUrl.class, InputStream.class, <span class="keyword">new</span> HttpGlideUrlLoader.Factory())</span><br><span class="line">              ....</span><br><span class="line">              <span class="comment">/* Transcoders */</span></span><br><span class="line">	    	 <span class="comment">//重点关注BitmapDrawableTranscoder</span></span><br><span class="line">        	 .register(</span><br><span class="line">            	 Bitmap.class,</span><br><span class="line">            	 BitmapDrawable.class,</span><br><span class="line">            	 <span class="keyword">new</span> BitmapDrawableTranscoder(resources))</span><br><span class="line">              .....</span><br><span class="line">          </span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面可以看出Glide对象的创建干的事情贼多，也极其复杂，总的来说其职责如下：</p>
<ul>
<li>创建RequestManagerRetriever对象</li>
<li>创建管理线程池与缓存的执行引擎Engine对象（下文需用到）</li>
<li>构建registry，注册了众多编解码器（下文需用到）</li>
</ul>
<p>其中在注册表registry中，上面的代码只列举了几个下面会用到的编解码器，实际上注册表的东西远不止这几个。我们重新确认下我们的目标获取RequestManagerRetriever对象，在上面的代码中已经new出了一个RequestManagerRetriever对象，并赋值到了Glide的成员变量，接下来就可以通过Glide的getRequestManagerRetriever方法获取到这个RequestManagerRetriever对象了。</p>
<h3 id="2-3-获取RequestManager对象"><a href="#2-3-获取RequestManager对象" class="headerlink" title="2.3 获取RequestManager对象"></a>2.3 获取RequestManager对象</h3><p>让我们重新看看其中一个with方法</p>
<blockquote>
<p>RequestManagerRetriever#with</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getRetriever(context).get(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们获取到了RequestManagerRetriever对象后，就需要通过RequestManagerRetriever的get方法获取RequestManager对象，在RequestManagerRetriever类中get跟Glide的with一样也有很多重载方法，重载方法对不同参数的处理是不同的，根据不同的处理可以分为两种类型的参数：</p>
<ul>
<li>Application类型</li>
<li>非Application类型（Activity/Fragment）</li>
</ul>
<h4 id="2-3-1-获取到Application类型的RequestManager对象"><a href="#2-3-1-获取到Application类型的RequestManager对象" class="headerlink" title="2.3.1 获取到Application类型的RequestManager对象"></a>2.3.1 获取到Application类型的RequestManager对象</h4><blockquote>
<p>RequestManagerRetriever#get</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//Application类型</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> RequestManager <span class="title">get</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"You cannot start a load on a null Context"</span>);</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Util.isOnMainThread() &amp;&amp; !(context <span class="keyword">instanceof</span> Application)) &#123;</span><br><span class="line">     <span class="comment">//若在主线程且context不为Application类型</span></span><br><span class="line">     <span class="keyword">if</span> (context <span class="keyword">instanceof</span> FragmentActivity) &#123;</span><br><span class="line">       <span class="keyword">return</span> get((FragmentActivity) context);</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (context <span class="keyword">instanceof</span> Activity) &#123;</span><br><span class="line">       <span class="keyword">return</span> get((Activity) context);</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (context <span class="keyword">instanceof</span> ContextWrapper) &#123;</span><br><span class="line">       <span class="keyword">return</span> get(((ContextWrapper) context).getBaseContext());</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//若不在主线程或者为Application类型的调用getApplicationManager获取一个RequestManager对象</span></span><br><span class="line">   <span class="keyword">return</span> getApplicationManager(context);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>可以发现，参数为context的get有两种处理:</p>
<ol>
<li>如果在主线程且context不为Application类型的就直接调用非Application类型的get方法</li>
<li>如果不在主线程或者为Application类型的就调用getApplicationManager获取RequestManager对象</li>
</ol>
<p>在这里我们分析的是Application类型的，所以直接看getApplicationManager方法</p>
<blockquote>
<p>RequestManagerRetriever#getApplicationManager</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">private</span> RequestManager <span class="title">getApplicationManager</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (applicationManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (applicationManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">//get方法为获取Glide的单例对象，</span></span><br><span class="line">          <span class="comment">//由于上面已经创建好Glide的单例对象了，所以在这里就直接取Glide的单例对象不需创建</span></span><br><span class="line">          Glide glide = Glide.get(context.getApplicationContext());</span><br><span class="line">          applicationManager =</span><br><span class="line">              factory.build(</span><br><span class="line">                  glide,</span><br><span class="line">                  <span class="keyword">new</span> ApplicationLifecycle(),</span><br><span class="line">                  <span class="keyword">new</span> EmptyRequestManagerTreeNode(),</span><br><span class="line">                  context.getApplicationContext());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> applicationManager;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestManagerFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function">RequestManager <span class="title">build</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull Glide glide,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull Lifecycle lifecycle,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull RequestManagerTreeNode requestManagerTreeNode,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull Context context)</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RequestManagerFactory DEFAULT_FACTORY = <span class="keyword">new</span> RequestManagerFactory() &#123;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RequestManager <span class="title">build</span><span class="params">(@NonNull Glide glide, @NonNull Lifecycle lifecycle,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull RequestManagerTreeNode requestManagerTreeNode, @NonNull Context context)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> RequestManager(glide, lifecycle, requestManagerTreeNode, context);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面的方法中，也是标准的单例实现，通过上面的分析我们知道Glide已经创建好了，并且Glide的get也是单例实现，所以直接获取到Glide对象，并new了一个ApplicationLifecycle，然后传入Glide和ApplicationLifecycle对象等并创建了RequestManager对象从而实现与Application生命周期的绑定。</p>
<p>那么为什么Glide可以直接绑定Application的生命周期呢？</p>
<p>这是因为Application对象的生命周期就是App的生命周期，所以Glide加载图片的生命周期直接与与应用程序的生命周期绑定的就行，不需要做特殊处理。</p>
<h4 id="2-3-2-获取到非Application类型的RequestManager对象"><a href="#2-3-2-获取到非Application类型的RequestManager对象" class="headerlink" title="2.3.2 获取到非Application类型的RequestManager对象"></a>2.3.2 获取到非Application类型的RequestManager对象</h4><p>这里我们只以参数为Activity类型的为代表，因为其它非Application类型的处理与Activity基本是类似的。</p>
<blockquote>
<p>RequestManagerRetriever#get</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 非Application类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestManager <span class="title">get</span><span class="params">(@NonNull FragmentActivity activity)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (Util.isOnBackgroundThread()) &#123;</span><br><span class="line"> <span class="comment">//如果在子线程则直接调用Aplication类型的get</span></span><br><span class="line">    <span class="keyword">return</span> get(activity.getApplicationContext());</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> <span class="comment">//判断Activity是否销毁</span></span><br><span class="line">    assertNotDestroyed(activity);</span><br><span class="line"> <span class="comment">//获取FragmentManager对象</span></span><br><span class="line">    FragmentManager fm = activity.getSupportFragmentManager();</span><br><span class="line"> <span class="comment">//通过调用supportFragmentGet返回RequestManager</span></span><br><span class="line">    <span class="keyword">return</span> supportFragmentGet(</span><br><span class="line">        activity, fm, <span class="comment">/*parentHint=*/</span> <span class="keyword">null</span>, isActivityVisible(activity));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于非Application类型的，首先要判断这个请求是在主线程中还是子线程中，如果是子线程中就调用Application类型的get方法，这也可以明白，因为在子线程中Glide的生命周期应该与Application的生命周期相一致。</p>
<p>如果是在主线程中，就调用supportFragmentGet方法来跟Activity的生命周期绑定。</p>
<blockquote>
<p>RequestManagerRetriever#supportFragmentGet</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">private</span> RequestManager <span class="title">supportFragmentGet</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">     @NonNull Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">     @NonNull FragmentManager fm,</span></span></span><br><span class="line"><span class="function"><span class="params">     @Nullable Fragment parentHint,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">boolean</span> isParentVisible)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//获取SupportRequestManagerFragment</span></span><br><span class="line">   SupportRequestManagerFragment current =</span><br><span class="line">       getSupportRequestManagerFragment(fm, parentHint, isParentVisible);</span><br><span class="line">   <span class="comment">//实现创建，添加Fragment  </span></span><br><span class="line">   RequestManager requestManager = current.getRequestManager();</span><br><span class="line"><span class="comment">//如果首次加载则初始化requestManager</span></span><br><span class="line">   <span class="keyword">if</span> (requestManager == <span class="keyword">null</span>) &#123; </span><br><span class="line">     Glide glide = Glide.get(context);</span><br><span class="line">     requestManager =</span><br><span class="line">         factory.build(</span><br><span class="line">             glide, current.getGlideLifecycle(), current.getRequestManagerTreeNode(), context);</span><br><span class="line">  <span class="comment">//设置到SupportRequestManagerFragment中</span></span><br><span class="line">  current.setRequestManager(requestManager);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> requestManager;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>supportFragmentGet是如何与Activity进行绑定的呢？其流程如下：</p>
<ol>
<li>创建隐藏的Fragment</li>
<li>向当前的Activity添加一个隐藏的Fragment</li>
<li>创建RequestManager对象，然后将RequestManager与隐藏的Fragment的生命周期进行绑定</li>
</ol>
<p>也许你会问为什么绑定了Activity中隐藏的Fragment生命周期就能与Activity进行绑定了呢？这是因为Fragment的生命周期与Activity是同步的，所以通过绑定的隐藏的Fragment就能监听Activity的生命周期，进而实现Glide加载图片的生命周期与Activity同步，并且通过这样的方法还能避免Glide持有Activity的实例而发生内存泄漏问题。</p>
<h2 id="3-小结"><a href="#3-小结" class="headerlink" title="3. 小结"></a>3. 小结</h2><p>到这里with的工作就结束了，让我们来总结一下with的主要工作</p>
<ul>
<li>构建Glide对象<ul>
<li>创建管理线程池与缓存的执行引擎Engine对象</li>
<li>构建registry，注册了众多编解码器</li>
<li>构建RequestManagerRetriever对象</li>
</ul>
</li>
<li>构建RequestManager对象<ul>
<li>如果在子线程中加载图片或with中的参数为Application类型，则Glide图片加载的生命周期与Application生命周期绑定</li>
<li>否则，Glide图片加载的生命周期与Activity或Fragment的生命周期绑定，绑定的方式：向当前的Activity/Fragment添加一个隐藏的Fragment，然后绑定这个隐藏的Fragment的生命周期。</li>
</ul>
</li>
</ul>
<h1 id="二、load"><a href="#二、load" class="headerlink" title="二、load"></a>二、load</h1><h2 id="1-作用-1"><a href="#1-作用-1" class="headerlink" title="1. 作用"></a>1. 作用</h2><p>创建一个目标为Drawable的图片加载请求，传入需要加载的资源（String,URL,URI等）</p>
<h2 id="2-流程-1"><a href="#2-流程-1" class="headerlink" title="2. 流程"></a>2. 流程</h2><h3 id="2-1-时序图-1"><a href="#2-1-时序图-1" class="headerlink" title="2.1 时序图"></a>2.1 时序图</h3><p><img src="/2019/10/18/Glide-4-9源码解析-图片加载流程/load.png" alt="1571226445492"></p>
<h3 id="2-2-创建RequestBuilder对象"><a href="#2-2-创建RequestBuilder对象" class="headerlink" title="2.2 创建RequestBuilder对象"></a>2.2 创建RequestBuilder对象</h3><p>从上面对with的分析，我们知道with最终会返回一个RequestManager对象，故第二部曲的开始就是RequestManager的load方法。</p>
<blockquote>
<p>RequestManager#load</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="title">load</span><span class="params">(@Nullable String string)</span> </span>&#123;</span><br><span class="line">  	<span class="comment">//1.asDrawable创建一个目标为Drawable的图片加载请求</span></span><br><span class="line">  	<span class="comment">//2.调用load将加载的资源传入</span></span><br><span class="line">    <span class="keyword">return</span> asDrawable().load(string);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="title">load</span><span class="params">(@Nullable Uri uri)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> asDrawable().load(uri);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="title">load</span><span class="params">(@Nullable URL url)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> asDrawable().load(url);</span><br><span class="line">  &#125;</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>
<p>可以发现load在RequestManager也是有很多重载方法的，但是下面我们只分析最常见的加载图片的load参数，即load(String url)。</p>
<p>在RequestManager的load方法中，首先会先调用asDrawable，让我们来看看asDrawable</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="title">asDrawable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> as(Drawable.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;ResourceType&gt; <span class="function">RequestBuilder&lt;ResourceType&gt; <span class="title">as</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    @NonNull Class&lt;ResourceType&gt; resourceClass)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> RequestBuilder&lt;&gt;(glide, <span class="keyword">this</span>, resourceClass, context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码很简单，就是创建了一个目标为Drawable的图片加载请求RequestBuilder。</p>
<h3 id="2-3-传入图片URL地址"><a href="#2-3-传入图片URL地址" class="headerlink" title="2.3 传入图片URL地址"></a>2.3 传入图片URL地址</h3><p>由于asDrawable返回的是RequestBuilder对象，因此下一步将会调用RequesBuilder的load方法</p>
<blockquote>
<p>RequesBuilder#load</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">load</span><span class="params">(@Nullable String string)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> loadGeneric(string);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">loadGeneric</span><span class="params">(@Nullable Object model)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//将数据赋值给RequestBuilder的静态成员变量</span></span><br><span class="line">  <span class="keyword">this</span>.model = model;</span><br><span class="line">  isModelSet = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码很容易理解，load调用了loadGeneric方法，loadGeneric方法中将数据，此时将String类型的model赋值给了RequestBuilder的静态成员变量。</p>
<h2 id="3-小结-1"><a href="#3-小结-1" class="headerlink" title="3. 小结"></a>3. 小结</h2><p>load估计是三部曲中最简单的一部曲子了，代码简单，也很容易理解。此部曲也是3.x与4.9的区别之一，在3.x的源码中load本来还应该完成一项任务，即预先创建好对图片进行一系列操作（加载，编解码，转码）的对象。而通过上述对with的分析，我们知道在4.9的源码中，这项工作已经交给with来处理了，所以load相比较其它两个来说，其工作是比较简单的。</p>
<h1 id="三、into"><a href="#三、into" class="headerlink" title="三、into"></a>三、into</h1><blockquote>
<p>！！！高能预警，into的源码分析将会很长很长很长</p>
</blockquote>
<h2 id="1-作用-2"><a href="#1-作用-2" class="headerlink" title="1. 作用"></a>1. 作用</h2><p>在子线程中网络请求解析图片，并回到主线程中展示图片</p>
<h2 id="2-流程-2"><a href="#2-流程-2" class="headerlink" title="2. 流程"></a>2. 流程</h2><blockquote>
<p>下列的源码基于load参数为String的情况下</p>
</blockquote>
<p>在上面对load的解析中我们知道，load执行完后返回的是RequestBuilder对象，所以into的入口就是RequestBuilder</p>
<blockquote>
<p>RequestBuilder#into</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ViewTarget&lt;ImageView, TranscodeType&gt; <span class="title">into</span><span class="params">(@NonNull ImageView view)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">     .....</span><br><span class="line">	<span class="comment">//返回ViewTarget对象</span></span><br><span class="line">    <span class="keyword">return</span> into(</span><br><span class="line">    	<span class="comment">//glideContext为GlideContext类型</span></span><br><span class="line">        glideContext.buildImageViewTarget(view, transcodeClass),</span><br><span class="line">        <span class="comment">/*targetListener=*/</span> <span class="keyword">null</span>,</span><br><span class="line">        requestOptions,</span><br><span class="line">        <span class="comment">//含有绑定主线程Handler的线程池</span></span><br><span class="line">        Executors.mainThreadExecutor());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面的代码中，我们知道在调用into之前会先获取要传递的参数，这里我们重点关注第一个参数和第四个参数。</p>
<h3 id="2-1-创建ViewTarget对象"><a href="#2-1-创建ViewTarget对象" class="headerlink" title="2.1 创建ViewTarget对象"></a>2.1 创建ViewTarget对象</h3><p>首先我们先分析GlideContext的buildImageViewTarget方法.</p>
<blockquote>
<p>GlideContext#buildImageViewTarget</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;X&gt; <span class="function">ViewTarget&lt;ImageView, X&gt; <span class="title">buildImageViewTarget</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    @NonNull ImageView imageView, @NonNull Class&lt;X&gt; transcodeClass)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> imageViewTargetFactory.buildTarget(imageView, transcodeClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时传入的transcodeClass其实就是我们在第二部曲中分析的asDrawable中传入的Drawable.class,然后继续调用了ImageViewTargetFactory的buildTarget方法。</p>
<blockquote>
<p>ImageViewTargetFactory#buildTarget</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;Z&gt; <span class="function">ViewTarget&lt;ImageView, Z&gt; <span class="title">buildTarget</span><span class="params">(@NonNull ImageView view,</span></span></span><br><span class="line"><span class="function"><span class="params">    @NonNull Class&lt;Z&gt; clazz)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (Bitmap.class.equals(clazz)) &#123;</span><br><span class="line"> <span class="comment">//若是调用了asBitmap方法</span></span><br><span class="line">    <span class="keyword">return</span> (ViewTarget&lt;ImageView, Z&gt;) <span class="keyword">new</span> BitmapImageViewTarget(view);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Drawable.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">    <span class="comment">//否则</span></span><br><span class="line">    <span class="keyword">return</span> (ViewTarget&lt;ImageView, Z&gt;) <span class="keyword">new</span> DrawableImageViewTarget(view);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">        <span class="string">"Unhandled class: "</span> + clazz + <span class="string">", try .as*(Class).transcode(ResourceTranscoder)"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为我们并没有调用asBitmap方法，并且传入的是Drawable类型，所以返回的ViewTarget对象应该是DrawableImageViewTarget，这个对象在展示图片时将会用到。</p>
<p><strong>！！！注：下文代码中出现的target，如果没有特殊说明都是DrawableImageViewTarget对象。</strong></p>
<h3 id="2-2-创建MAIN-THREAD-EXECUTOR"><a href="#2-2-创建MAIN-THREAD-EXECUTOR" class="headerlink" title="2.2 创建MAIN_THREAD_EXECUTOR"></a>2.2 创建MAIN_THREAD_EXECUTOR</h3><p>让我们回到前面的into方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> ViewTarget&lt;ImageView, TranscodeType&gt; <span class="title">into</span><span class="params">(@NonNull ImageView view)</span> </span>&#123;</span><br><span class="line">   ....</span><br><span class="line"><span class="comment">//返回ViewTarget对象</span></span><br><span class="line">   <span class="keyword">return</span> into(</span><br><span class="line">   	<span class="comment">//buildImageViewTarget创建ViewTarget对象</span></span><br><span class="line">   	<span class="comment">//transcodeClass若调用了asBitmap则为Bitmap，相应的返回BitmapImageViewTarget，</span></span><br><span class="line">    <span class="comment">//否则transcodeClass为Drawable类型，返回DrawableImageViewTarget    </span></span><br><span class="line">       glideContext.buildImageViewTarget(view, transcodeClass),</span><br><span class="line">       <span class="comment">/*targetListener=*/</span> <span class="keyword">null</span>,</span><br><span class="line">       requestOptions,</span><br><span class="line">       <span class="comment">//含有绑定主线程Handler的线程池</span></span><br><span class="line">       Executors.mainThreadExecutor());</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>接着我们继续分析第四个参数</p>
<blockquote>
<p>Executors#mainThreadExecutor</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor MAIN_THREAD_EXECUTOR =</span><br><span class="line">      <span class="keyword">new</span> Executor() &#123;</span><br><span class="line">       <span class="comment">//绑定主线程的Looper</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Handler handler = <span class="keyword">new</span> Handler(Looper.getMainLooper());</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(@NonNull Runnable command)</span> </span>&#123;</span><br><span class="line">          handler.post(command);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Executor <span class="title">mainThreadExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> MAIN_THREAD_EXECUTOR;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>从上面可以发现在这个mainThreadExecutor中返回的是MAIN_THREAD_EXECUTOR，而MAIN_THREAD_EXECUTOR声明了一个绑定了主线程Looper的Handler，然后这个线程池的execute方法会执行handler的post方法，相当于在主线程中执行command的run方法。（这里先讲明白这个线程池，因为当分析到最后在主线程中显示图片时会重新分析到这个参数，另外这里涉及到了Handler机制的知识，不懂的可以看看前面写的博客<a href="https://blog.csdn.net/qq_41979349/article/details/98107823" target="_blank" rel="noopener">Android之Handler机制</a>）</p>
<p>分析完了into的两个参数，我们接下来就看看这个重载into方法</p>
<blockquote>
<p>RequestBuilder#into</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> &lt;Y extends Target&lt;TranscodeType&gt;&gt; <span class="function">Y <span class="title">into</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">     @NonNull Y target,</span></span></span><br><span class="line"><span class="function"><span class="params">     @Nullable RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">     BaseRequestOptions&lt;?&gt; options,</span></span></span><br><span class="line"><span class="function"><span class="params">     Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">   Preconditions.checkNotNull(target);</span><br><span class="line">   <span class="keyword">if</span> (!isModelSet) &#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"You must call #load() before calling #into()"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//构建Requset对象，发出加载图片请求</span></span><br><span class="line">   <span class="comment">//注意第四个参数传进去的是含有绑定主线程的Handler的线程池</span></span><br><span class="line">   Request request = buildRequest(target, targetListener, options, callbackExecutor);</span><br><span class="line">   <span class="comment">//在开始前先释放掉target对象已存在的请求</span></span><br><span class="line">   Request previous = target.getRequest();</span><br><span class="line">   <span class="keyword">if</span> (request.isEquivalentTo(previous)</span><br><span class="line">       &amp;&amp; !isSkipMemoryCacheWithCompletePreviousRequest(options, previous)) &#123;</span><br><span class="line">     request.recycle();</span><br><span class="line">     </span><br><span class="line">     <span class="keyword">if</span> (!Preconditions.checkNotNull(previous).isRunning()) &#123;</span><br><span class="line">       previous.begin();</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> target;</span><br><span class="line">   &#125;</span><br><span class="line">	</span><br><span class="line">   requestManager.clear(target);</span><br><span class="line"></span><br><span class="line"><span class="comment">//将请求设置到target中</span></span><br><span class="line">   target.setRequest(request);</span><br><span class="line"><span class="comment">//分发并执行网络请求Request，此时的requestManager就是</span></span><br><span class="line">   requestManager.track(target, request);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> target;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>我们可以发现在这个方法中，其实主要的工作有两个：一是构建网络请求的Request，二是执行网络请求对象Request，接下来我们就分别对这两个工作进行分析。</p>
<h3 id="2-3-构建网络请求对象Request"><a href="#2-3-构建网络请求对象Request" class="headerlink" title="2.3 构建网络请求对象Request"></a>2.3 构建网络请求对象Request</h3><blockquote>
<p>RequestBuilder#buildRequest</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Request <span class="title">buildRequest</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Target&lt;TranscodeType&gt; target,</span></span></span><br><span class="line"><span class="function"><span class="params">    @Nullable RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">    BaseRequestOptions&lt;?&gt; requestOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">    Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//重点关注buildRequestRecursive方法  </span></span><br><span class="line">  <span class="keyword">return</span> buildRequestRecursive(</span><br><span class="line">      target,</span><br><span class="line">      targetListener,</span><br><span class="line">      <span class="comment">/*parentCoordinator=*/</span> <span class="keyword">null</span>,</span><br><span class="line">      transitionOptions,</span><br><span class="line">      requestOptions.getPriority(),</span><br><span class="line">      requestOptions.getOverrideWidth(),</span><br><span class="line">      requestOptions.getOverrideHeight(),</span><br><span class="line">      requestOptions,</span><br><span class="line">      callbackExecutor);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Request <span class="title">buildRequestRecursive</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Target&lt;TranscodeType&gt; target,</span></span></span><br><span class="line"><span class="function"><span class="params">    @Nullable RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">    @Nullable RequestCoordinator parentCoordinator,</span></span></span><br><span class="line"><span class="function"><span class="params">    TransitionOptions&lt;?, ? <span class="keyword">super</span> TranscodeType&gt; transitionOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">    Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> overrideWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> overrideHeight,</span></span></span><br><span class="line"><span class="function"><span class="params">    BaseRequestOptions&lt;?&gt; requestOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">    Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  .....</span><br><span class="line">  <span class="comment">//重点关注buildThumbnailRequestRecursive方法</span></span><br><span class="line">  Request mainRequest =</span><br><span class="line">      buildThumbnailRequestRecursive(</span><br><span class="line">          target,</span><br><span class="line">          targetListener,</span><br><span class="line">          parentCoordinator,</span><br><span class="line">          transitionOptions,</span><br><span class="line">          priority,</span><br><span class="line">          overrideWidth,</span><br><span class="line">          overrideHeight,</span><br><span class="line">          requestOptions,</span><br><span class="line">          callbackExecutor);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (errorRequestCoordinator == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mainRequest;</span><br><span class="line">  &#125;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Request <span class="title">buildThumbnailRequestRecursive</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Target&lt;TranscodeType&gt; target,</span></span></span><br><span class="line"><span class="function"><span class="params">    RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">    @Nullable RequestCoordinator parentCoordinator,</span></span></span><br><span class="line"><span class="function"><span class="params">    TransitionOptions&lt;?, ? <span class="keyword">super</span> TranscodeType&gt; transitionOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">    Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> overrideWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> overrideHeight,</span></span></span><br><span class="line"><span class="function"><span class="params">    BaseRequestOptions&lt;?&gt; requestOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">    Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">    ....</span><br><span class="line">    <span class="comment">//重点关注，关键代码</span></span><br><span class="line"> Request fullRequest =</span><br><span class="line">        obtainRequest(</span><br><span class="line">            target,</span><br><span class="line">            targetListener,</span><br><span class="line">            requestOptions,</span><br><span class="line">            coordinator,</span><br><span class="line">            transitionOptions,</span><br><span class="line">            priority,</span><br><span class="line">            overrideWidth,</span><br><span class="line">            overrideHeight,</span><br><span class="line">            callbackExecutor);</span><br><span class="line">    ........ </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Request <span class="title">obtainRequest</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Target&lt;TranscodeType&gt; target,</span></span></span><br><span class="line"><span class="function"><span class="params">    RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">    BaseRequestOptions&lt;?&gt; requestOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">    RequestCoordinator requestCoordinator,</span></span></span><br><span class="line"><span class="function"><span class="params">    TransitionOptions&lt;?, ? <span class="keyword">super</span> TranscodeType&gt; transitionOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">    Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> overrideWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> overrideHeight,</span></span></span><br><span class="line"><span class="function"><span class="params">    Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//调用了SingleRequest的obtain方法，将load中调用的所有API参数都组装到Request对象当中</span></span><br><span class="line">  <span class="comment">//此时的callbackExecutor为含有绑定主线程Handler的线程池  </span></span><br><span class="line">  <span class="keyword">return</span> SingleRequest.obtain(</span><br><span class="line">      context,</span><br><span class="line">      glideContext,</span><br><span class="line">      model,</span><br><span class="line">      transcodeClass,</span><br><span class="line">      requestOptions,</span><br><span class="line">      overrideWidth,</span><br><span class="line">      overrideHeight,</span><br><span class="line">      priority,</span><br><span class="line">      target,</span><br><span class="line">      targetListener,</span><br><span class="line">      requestListeners,</span><br><span class="line">      requestCoordinator,</span><br><span class="line">      glideContext.getEngine(),</span><br><span class="line">      transitionOptions.getTransitionFactory(),</span><br><span class="line">      callbackExecutor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过一步一步调用，最终将会执行SingleRequest的obtain方法，所以我们继续看这个方法</p>
<blockquote>
<p>SingleRequest#obtain方法</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> &lt;R&gt; <span class="function">SingleRequest&lt;R&gt; <span class="title">obtain</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">     Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">     GlideContext glideContext,</span></span></span><br><span class="line"><span class="function"><span class="params">     Object model,</span></span></span><br><span class="line"><span class="function"><span class="params">     Class&lt;R&gt; transcodeClass,</span></span></span><br><span class="line"><span class="function"><span class="params">     BaseRequestOptions&lt;?&gt; requestOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">int</span> overrideWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">int</span> overrideHeight,</span></span></span><br><span class="line"><span class="function"><span class="params">     Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">     Target&lt;R&gt; target,</span></span></span><br><span class="line"><span class="function"><span class="params">     RequestListener&lt;R&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">     @Nullable List&lt;RequestListener&lt;R&gt;&gt; requestListeners,</span></span></span><br><span class="line"><span class="function"><span class="params">     RequestCoordinator requestCoordinator,</span></span></span><br><span class="line"><span class="function"><span class="params">     Engine engine,</span></span></span><br><span class="line"><span class="function"><span class="params">     TransitionFactory&lt;? <span class="keyword">super</span> R&gt; animationFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">     Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">   <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>) SingleRequest&lt;R&gt; request =</span><br><span class="line">       (SingleRequest&lt;R&gt;) POOL.acquire();</span><br><span class="line">   <span class="keyword">if</span> (request == <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="comment">//创建SingleRequest对象</span></span><br><span class="line">     request = <span class="keyword">new</span> SingleRequest&lt;&gt;();</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//将传入load中的API参数赋值到SingleRequest的成员变量</span></span><br><span class="line"><span class="comment">//最后一个参数为主线程的线程池</span></span><br><span class="line">   request.init(</span><br><span class="line">       context,</span><br><span class="line">       glideContext,</span><br><span class="line">       model,</span><br><span class="line">       transcodeClass,</span><br><span class="line">       requestOptions,</span><br><span class="line">       overrideWidth,</span><br><span class="line">       overrideHeight,</span><br><span class="line">       priority,</span><br><span class="line">       target,</span><br><span class="line">       targetListener,</span><br><span class="line">       requestListeners,</span><br><span class="line">       requestCoordinator,</span><br><span class="line">       engine,</span><br><span class="line">       animationFactory,</span><br><span class="line">       callbackExecutor);</span><br><span class="line">   <span class="keyword">return</span> request;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//对成员变量赋值</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">     Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">     GlideContext glideContext,</span></span></span><br><span class="line"><span class="function"><span class="params">     Object model,</span></span></span><br><span class="line"><span class="function"><span class="params">     Class&lt;R&gt; transcodeClass,</span></span></span><br><span class="line"><span class="function"><span class="params">     BaseRequestOptions&lt;?&gt; requestOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">int</span> overrideWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">int</span> overrideHeight,</span></span></span><br><span class="line"><span class="function"><span class="params">     Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">     Target&lt;R&gt; target,</span></span></span><br><span class="line"><span class="function"><span class="params">     RequestListener&lt;R&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">     @Nullable List&lt;RequestListener&lt;R&gt;&gt; requestListeners,</span></span></span><br><span class="line"><span class="function"><span class="params">     RequestCoordinator requestCoordinator,</span></span></span><br><span class="line"><span class="function"><span class="params">     Engine engine,</span></span></span><br><span class="line"><span class="function"><span class="params">     TransitionFactory&lt;? <span class="keyword">super</span> R&gt; animationFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">     Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">this</span>.context = context;</span><br><span class="line">   <span class="keyword">this</span>.glideContext = glideContext;</span><br><span class="line">   <span class="keyword">this</span>.model = model;</span><br><span class="line">   <span class="keyword">this</span>.transcodeClass = transcodeClass;</span><br><span class="line">   <span class="keyword">this</span>.requestOptions = requestOptions;</span><br><span class="line">   <span class="keyword">this</span>.overrideWidth = overrideWidth;</span><br><span class="line">   <span class="keyword">this</span>.overrideHeight = overrideHeight;</span><br><span class="line">   <span class="keyword">this</span>.priority = priority;</span><br><span class="line">   <span class="keyword">this</span>.target = target;</span><br><span class="line">   <span class="keyword">this</span>.targetListener = targetListener;</span><br><span class="line">   <span class="keyword">this</span>.requestListeners = requestListeners;</span><br><span class="line">   <span class="keyword">this</span>.requestCoordinator = requestCoordinator;</span><br><span class="line">   <span class="keyword">this</span>.engine = engine;</span><br><span class="line">   <span class="keyword">this</span>.animationFactory = animationFactory;</span><br><span class="line">   <span class="keyword">this</span>.callbackExecutor = callbackExecutor;</span><br><span class="line">   status = Status.PENDING;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (requestOrigin == <span class="keyword">null</span> &amp;&amp; glideContext.isLoggingRequestOriginsEnabled()) &#123;</span><br><span class="line">     requestOrigin = <span class="keyword">new</span> RuntimeException(<span class="string">"Glide request origin trace"</span>);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这个obtain方法其实就是创建了SingleRequest对象，然后调用了init方法进行成员变量的赋值，所以构建的网络请求对象就是SingleRequest对象。</p>
<h3 id="2-4-执行网络请求对象Request"><a href="#2-4-执行网络请求对象Request" class="headerlink" title="2.4 执行网络请求对象Request"></a>2.4 执行网络请求对象Request</h3><p>让我们回到into方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> &lt;Y extends Target&lt;TranscodeType&gt;&gt; <span class="function">Y <span class="title">into</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">     @NonNull Y target,</span></span></span><br><span class="line"><span class="function"><span class="params">     @Nullable RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">     BaseRequestOptions&lt;?&gt; options,</span></span></span><br><span class="line"><span class="function"><span class="params">     Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//构建Requset对象，发出加载图片请求</span></span><br><span class="line">   <span class="comment">//最终构建的是SingleRequest对象</span></span><br><span class="line">   Request request = buildRequest(target, targetListener, options, callbackExecutor);  </span><br><span class="line">   .....</span><br><span class="line"><span class="comment">//分发并执行网络请求Request，此时的requestManager就是RequestManager对象</span></span><br><span class="line">   <span class="comment">//target为上述创建的DrawableImageViewTarget(如果忘记可以重新看回2.1)</span></span><br><span class="line">   <span class="comment">//request就是创建完成的singleRequest对象    </span></span><br><span class="line">   requestManager.track(target, request);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> target;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这时候我们已经成功构建出了SingleRequest对象了，然后调用了RequestManager的track方法进行分发并执行这个请求</p>
<h4 id="2-4-1-加载前"><a href="#2-4-1-加载前" class="headerlink" title="2.4.1 加载前"></a>2.4.1 加载前</h4><blockquote>
<p>RequestManager#track</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">track</span><span class="params">(@NonNull Target&lt;?&gt; target, @NonNull Request request)</span> </span>&#123;</span><br><span class="line">   targetTracker.track(target);</span><br><span class="line"><span class="comment">//执行网络请求</span></span><br><span class="line">   requestTracker.runRequest(request);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>RequestTracker#runRequest</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runRequest</span><span class="params">(@NonNull Request request)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//将每个提交的请求加入到一个set中，从而实现管理请求</span></span><br><span class="line">   requests.add(request);</span><br><span class="line"><span class="comment">//判断Glide当前是否处于暂停状态</span></span><br><span class="line">   <span class="keyword">if</span> (!isPaused) &#123;</span><br><span class="line">  <span class="comment">//如果不暂停，则调用SingleRequest的begin方法来执行request</span></span><br><span class="line">     request.begin();</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     request.clear();</span><br><span class="line">     <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">       Log.v(TAG, <span class="string">"Paused, delaying request"</span>);</span><br><span class="line">     &#125;</span><br><span class="line">  <span class="comment">//如果暂停，则先将当前的请求添加到待执行队列里面，等待暂停状态解除后再执行</span></span><br><span class="line">     pendingRequests.add(request);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>在加载图片前，即开启网络请求前我们需要将每个请求加到set中来进行管理请求，并且还需要判断Glide当前的状态，因为我们现在分析的是图片加载流程，显然这里的Glide不是暂停状态，所以会执行request的begin方法，由于在上面我们已经分析了网络请求对象为SingleRequest，所以这里的request为SingleRequest对象。</p>
<h4 id="2-4-2-加载时"><a href="#2-4-2-加载时" class="headerlink" title="2.4.2 加载时"></a>2.4.2 加载时</h4><p>接着我们来看看SingleRequest的begin方法</p>
<blockquote>
<p>SingleRequest#begin</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   ....</span><br><span class="line"><span class="comment">//model为load传入的图片URL地址</span></span><br><span class="line">   <span class="keyword">if</span> (model == <span class="keyword">null</span>) &#123;</span><br><span class="line">     <span class="keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight)) &#123;</span><br><span class="line">       width = overrideWidth;</span><br><span class="line">       height = overrideHeight;</span><br><span class="line">     &#125;</span><br><span class="line">      </span><br><span class="line">     <span class="keyword">int</span> logLevel = getFallbackDrawable() == <span class="keyword">null</span> ? Log.WARN : Log.DEBUG;</span><br><span class="line">  <span class="comment">//如果传入的URL地址为空，则会调用onLoadFailed</span></span><br><span class="line">     onLoadFailed(<span class="keyword">new</span> GlideException(<span class="string">"Received null model"</span>), logLevel);</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   status = Status.WAITING_FOR_SIZE;</span><br><span class="line">   <span class="keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight)) &#123;</span><br><span class="line">  <span class="comment">//重点关注</span></span><br><span class="line">     onSizeReady(overrideWidth, overrideHeight);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   　<span class="comment">//getsize计算宽高，然后执行onSizeReady方法</span></span><br><span class="line">     target.getSize(<span class="keyword">this</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> ((status == Status.RUNNING || status == Status.WAITING_FOR_SIZE)</span><br><span class="line">       &amp;&amp; canNotifyStatusChanged()) &#123;</span><br><span class="line">     <span class="comment">//在图片请求成功前，会先使用Loading占位图代替最终的图片显示  </span></span><br><span class="line">     target.onLoadStarted(getPlaceholderDrawable());</span><br><span class="line">   &#125;</span><br><span class="line">   .....</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h5 id="1-onLoadFailed"><a href="#1-onLoadFailed" class="headerlink" title="1. onLoadFailed"></a>1. onLoadFailed</h5><p>从上面的代码中我们可以发现当model为null时，即load传入的图片地址为空时，会调用onLoadFailed方法</p>
<blockquote>
<p>SingleRequest#onLoadFailed</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">onLoadFailed</span><span class="params">(GlideException e, <span class="keyword">int</span> maxLogLevel)</span> </span>&#123;</span><br><span class="line">   .....</span><br><span class="line"></span><br><span class="line">   loadStatus = <span class="keyword">null</span>;</span><br><span class="line">   status = Status.FAILED;</span><br><span class="line"></span><br><span class="line">   isCallingCallbacks = <span class="keyword">true</span>;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="comment">//<span class="doctag">TODO:</span> what if this is a thumbnail request?</span></span><br><span class="line">     <span class="keyword">boolean</span> anyListenerHandledUpdatingTarget = <span class="keyword">false</span>;</span><br><span class="line">     <span class="keyword">if</span> (requestListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="keyword">for</span> (RequestListener&lt;R&gt; listener : requestListeners) &#123;</span><br><span class="line">         anyListenerHandledUpdatingTarget |=</span><br><span class="line">             listener.onLoadFailed(e, model, target, isFirstReadyResource());</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     anyListenerHandledUpdatingTarget |=</span><br><span class="line">         targetListener != <span class="keyword">null</span></span><br><span class="line">             &amp;&amp; targetListener.onLoadFailed(e, model, target, isFirstReadyResource());</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (!anyListenerHandledUpdatingTarget) &#123;</span><br><span class="line">  	<span class="comment">//重点关注这个方法</span></span><br><span class="line">       setErrorPlaceholder();</span><br><span class="line">     &#125;</span><br><span class="line">   &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">     isCallingCallbacks = <span class="keyword">false</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   notifyLoadFailed();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">setErrorPlaceholder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (!canNotifyStatusChanged()) &#123;</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   Drawable error = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">//先获取fallback的图片</span></span><br><span class="line">   <span class="keyword">if</span> (model == <span class="keyword">null</span>) &#123;</span><br><span class="line">     error = getFallbackDrawable();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//若没有设置fallback图，则获取error图</span></span><br><span class="line">   <span class="keyword">if</span> (error == <span class="keyword">null</span>) &#123;</span><br><span class="line">     error = getErrorDrawable();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//若没有error图，则再获取一个loading的占位图</span></span><br><span class="line">   <span class="keyword">if</span> (error == <span class="keyword">null</span>) &#123;</span><br><span class="line">     error = getPlaceholderDrawable();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//target为DrawableImageViewTarget  </span></span><br><span class="line">   target.onLoadFailed(error);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>在onLoadFailed方法中我们只需要关注setErrorPlaceholder方法，而在setErrorPlaceholder中主要的逻辑就是获取错误时需要展示的图片，按fallback&gt;error&gt;loading的优先级来获取错误时的图片，然后调用DrawableImageViewTarget的onLoadFailed方法。通过查看DrawableImageViewTarget，我们可以发现这个类中并没有onLoadFailed方法，所以我们自然而然找父类ImageViewTarget是否存在这个方法.</p>
<blockquote>
<p>ImageViewTarget#onloadFailed</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoadFailed</span><span class="params">(@Nullable Drawable errorDrawable)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">super</span>.onLoadFailed(errorDrawable);</span><br><span class="line">   setResourceInternal(<span class="keyword">null</span>);</span><br><span class="line"><span class="comment">//调用setDrawable将图片显示出来</span></span><br><span class="line">   setDrawable(errorDrawable);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDrawable</span><span class="params">(Drawable drawable)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//view就是ImageView,将图片展示出来</span></span><br><span class="line">   view.setImageDrawable(drawable);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>到这里，错误的图片就被显示出来，从这里我们可以看出Glide显示错误的图片的原则就是：当传入图片的url为null时，会才采用fallback/error/loading的占位图进行代替。</p>
<h5 id="2-onLoadStarted"><a href="#2-onLoadStarted" class="headerlink" title="2. onLoadStarted"></a>2. onLoadStarted</h5><p>分析完onLoadFailed，我们回到SingleRequest的begin方法，本来按代码顺序接下来应该分析的是onSizeReady，但是由于这个方法比较复杂并且onLoadStarted与onLoadStarted很类似，所以我们先分析onLoadStarted，把onSizeReady放到最后。</p>
<blockquote>
<p>SingleRequest#begin 与onLoadStarted相关的代码</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((status == Status.RUNNING || status == Status.WAITING_FOR_SIZE)</span><br><span class="line">    &amp;&amp; canNotifyStatusChanged()) &#123;</span><br><span class="line">  <span class="comment">//在图片请求成功前，会先使用Loading占位图代替最终的图片显示  </span></span><br><span class="line">  target.onLoadStarted(getPlaceholderDrawable());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看上面这个逻辑就是当图片正在请求时或者等待执行onSizeReady方法时，就执行DrawableImageViewTarget的onLoadStarted方法，从onLoadFailed方法的分析我们已经知道，onLoadFailed方法是在DrawableImageViewTarget父类ImageViewTarget中，故onLoadStarted也是在ImageViewTarget中，至于参数就是loading的占位图。</p>
<blockquote>
<p>ImageViewTarget#onLoadStarted</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoadStarted</span><span class="params">(@Nullable Drawable placeholder)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">super</span>.onLoadStarted(placeholder);</span><br><span class="line">   setResourceInternal(<span class="keyword">null</span>);</span><br><span class="line"><span class="comment">//在图片请求开始前，会先使用Loading占位图代替最终的图片显示</span></span><br><span class="line">   setDrawable(placeholder);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDrawable</span><span class="params">(Drawable drawable)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//将图片展示出来</span></span><br><span class="line">   view.setImageDrawable(drawable);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>然后将loading的占位图显示出来，即图片请求成功前，会使用Loading占位图代替最终的图片显示。这也算是我们经常使用的一个功能了。</p>
<h5 id="3-onSizeReady"><a href="#3-onSizeReady" class="headerlink" title="3. onSizeReady"></a>3. onSizeReady</h5><p>到这里我们终于要分析重头戏onSizeReady了，我们先贴出相关代码</p>
<blockquote>
<p>SingleRequest#begin 与onSizeReady相关的代码</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//图片加载有两种情况：</span></span><br><span class="line"><span class="comment">//1.使用了override()的API为图片指定了固定宽高</span></span><br><span class="line"><span class="comment">//2.无使用</span></span><br><span class="line">   <span class="keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight)) &#123;</span><br><span class="line">	<span class="comment">//第一种情况，指定了宽高的话调用onSizeReady加载</span></span><br><span class="line">     onSizeReady(overrideWidth, overrideHeight);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   　<span class="comment">//getsize计算宽高，然后执行onSizeReady方法</span></span><br><span class="line">     <span class="comment">//(从DrawableImageViewTarget中向上追踪，会在ViewTarget中发现这个方法)</span></span><br><span class="line">     target.getSize(<span class="keyword">this</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这个我们只分析onSizeReady，因为getSize方法最终也是会调用onSizeReady的。</p>
<blockquote>
<p>SingleRequest#onSizeReady</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">onSizeReady</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">  ....</span><br><span class="line">  status = Status.RUNNING;</span><br><span class="line"></span><br><span class="line">  loadStatus =</span><br><span class="line">  	<span class="comment">//重点关注，调用Engine的load构建任务</span></span><br><span class="line">  	<span class="comment">//重点关注倒数第二个参数，传入自身SingleRequest，在回调的时候会使用</span></span><br><span class="line">  	<span class="comment">//重点关注倒数第一个参数，传入有绑定主线程的Handler的线程池callbackExectuter</span></span><br><span class="line">      engine.load(</span><br><span class="line">          glideContext,</span><br><span class="line">          model,</span><br><span class="line">          requestOptions.getSignature(),</span><br><span class="line">          <span class="keyword">this</span>.width,</span><br><span class="line">          <span class="keyword">this</span>.height,</span><br><span class="line">          requestOptions.getResourceClass(),</span><br><span class="line">          transcodeClass,</span><br><span class="line">          priority,</span><br><span class="line">          requestOptions.getDiskCacheStrategy(),</span><br><span class="line">          requestOptions.getTransformations(),</span><br><span class="line">          requestOptions.isTransformationRequired(),</span><br><span class="line">          requestOptions.isScaleOnlyOrNoTransform(),</span><br><span class="line">          requestOptions.getOptions(),</span><br><span class="line">          requestOptions.isMemoryCacheable(),</span><br><span class="line">          requestOptions.getUseUnlimitedSourceGeneratorsPool(),</span><br><span class="line">          requestOptions.getUseAnimationPool(),</span><br><span class="line">          requestOptions.getOnlyRetrieveFromCache(),</span><br><span class="line">          <span class="keyword">this</span>,</span><br><span class="line">          callbackExecutor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出onSizeReady的实现交给了Engine的load方法实现了，这个Engine对象就是在第一部曲with中Glide构建时提到的执行引擎，在这里还需要特别注意的是传给load的最后两个参数，因为这两个参数在后面的分析需要用到。</p>
<h6 id="构建任务"><a href="#构建任务" class="headerlink" title="构建任务"></a>构建任务</h6><blockquote>
<p>Engine#load</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">synchronized</span> &lt;R&gt; <span class="function">LoadStatus <span class="title">load</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">     GlideContext glideContext,</span></span></span><br><span class="line"><span class="function"><span class="params">     Object model,</span></span></span><br><span class="line"><span class="function"><span class="params">     Key signature,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">int</span> width,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">int</span> height,</span></span></span><br><span class="line"><span class="function"><span class="params">     Class&lt;?&gt; resourceClass,</span></span></span><br><span class="line"><span class="function"><span class="params">     Class&lt;R&gt; transcodeClass,</span></span></span><br><span class="line"><span class="function"><span class="params">     Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">     DiskCacheStrategy diskCacheStrategy,</span></span></span><br><span class="line"><span class="function"><span class="params">     Map&lt;Class&lt;?&gt;, Transformation&lt;?&gt;&gt; transformations,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">boolean</span> isTransformationRequired,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">boolean</span> isScaleOnlyOrNoTransform,</span></span></span><br><span class="line"><span class="function"><span class="params">     Options options,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">boolean</span> isMemoryCacheable,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">boolean</span> useUnlimitedSourceExecutorPool,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">boolean</span> useAnimationPool,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">boolean</span> onlyRetrieveFromCache,</span></span></span><br><span class="line"><span class="function"><span class="params">     ResourceCallback cb,</span></span></span><br><span class="line"><span class="function"><span class="params">     Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">   .....</span><br><span class="line"><span class="comment">//从缓存中查找key对应的任务</span></span><br><span class="line">   EngineJob&lt;?&gt; current = jobs.get(key, onlyRetrieveFromCache);</span><br><span class="line">   <span class="keyword">if</span> (current != <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="comment">//如果走到这说明该任务已经正在执行了，无需再次构建执行</span></span><br><span class="line">  <span class="comment">//可以先不看，从后面分析完后重新回头看这个</span></span><br><span class="line">     current.addCallback(cb, callbackExecutor);</span><br><span class="line">     <span class="keyword">if</span> (VERBOSE_IS_LOGGABLE) &#123;</span><br><span class="line">       logWithTimeAndKey(<span class="string">"Added to existing load"</span>, startTime, key);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> LoadStatus(cb, current);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//走到这，说明这是个新任务</span></span><br><span class="line">   <span class="comment">//创建EngineJob对象，用来开启线程（异步加载图片）</span></span><br><span class="line">   EngineJob&lt;R&gt; engineJob =</span><br><span class="line">       engineJobFactory.build(</span><br><span class="line">           key,</span><br><span class="line">           isMemoryCacheable,</span><br><span class="line">           useUnlimitedSourceExecutorPool,</span><br><span class="line">           useAnimationPool,</span><br><span class="line">           onlyRetrieveFromCache);</span><br><span class="line">   <span class="comment">//创建DecodeJob对象，用来对图片解码</span></span><br><span class="line">   DecodeJob&lt;R&gt; decodeJob =</span><br><span class="line">       decodeJobFactory.build(</span><br><span class="line">           glideContext,</span><br><span class="line">           model,</span><br><span class="line">           key,</span><br><span class="line">           signature,</span><br><span class="line">           width,</span><br><span class="line">           height,</span><br><span class="line">           resourceClass,</span><br><span class="line">           transcodeClass,</span><br><span class="line">           priority,</span><br><span class="line">           diskCacheStrategy,</span><br><span class="line">           transformations,</span><br><span class="line">           isTransformationRequired,</span><br><span class="line">           isScaleOnlyOrNoTransform,</span><br><span class="line">           onlyRetrieveFromCache,</span><br><span class="line">           options,</span><br><span class="line">           engineJob);</span><br><span class="line">   <span class="comment">//添加到任务缓存中</span></span><br><span class="line">   jobs.put(key, engineJob);</span><br><span class="line">   <span class="comment">//现在可以不看</span></span><br><span class="line">   <span class="comment">//在获取数据回调进行照片展示时会重新分析到这个方法</span></span><br><span class="line">   engineJob.addCallback(cb, callbackExecutor);</span><br><span class="line"><span class="comment">//执行任务</span></span><br><span class="line">   engineJob.start(decodeJob);</span><br><span class="line">   ...  </span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> LoadStatus(cb, engineJob);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>结合上面的代码和注释，我们可以知道Engine.load的主要工作：</p>
<ul>
<li>创建EngineJob对象，用来开启线程</li>
<li>创建DeodeJob对象，用来对照片进行解码</li>
<li>添加回调的对象和线程池</li>
<li>执行任务</li>
</ul>
<h6 id="执行任务"><a href="#执行任务" class="headerlink" title="执行任务"></a>执行任务</h6><blockquote>
<p>EngineJob#start</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(DecodeJob&lt;R&gt; decodeJob)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">this</span>.decodeJob = decodeJob;</span><br><span class="line"><span class="comment">//获取线程池</span></span><br><span class="line">   GlideExecutor executor = decodeJob.willDecodeFromCache()</span><br><span class="line">       ? diskCacheExecutor</span><br><span class="line">       : getActiveSourceExecutor();</span><br><span class="line"><span class="comment">//执行DecodeJob的run方法</span></span><br><span class="line">   executor.execute(decodeJob);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>调用线程池的execute方法，故接下来会执行DecodeJob的run方法</p>
<blockquote>
<p>DecodeJob#run</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   ....</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (isCancelled) &#123;</span><br><span class="line">       notifyFailed();</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line">  <span class="comment">//重点关注，调用runWrapped</span></span><br><span class="line">     runWrapped();</span><br><span class="line">   &#125; </span><br><span class="line">   ....</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runWrapped</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">switch</span> (runReason) &#123;</span><br><span class="line">     <span class="keyword">case</span> INITIALIZE:</span><br><span class="line">  	<span class="comment">//获取任务场景</span></span><br><span class="line">       stage = getNextStage(Stage.INITIALIZE);</span><br><span class="line">    <span class="comment">//获取这个场景的执行者</span></span><br><span class="line">       currentGenerator = getNextGenerator();</span><br><span class="line">    <span class="comment">//重点关注，执行者执行任务</span></span><br><span class="line">       runGenerators();</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">     <span class="keyword">case</span> SWITCH_TO_SOURCE_SERVICE:</span><br><span class="line">       runGenerators();</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">     <span class="keyword">case</span> DECODE_DATA:</span><br><span class="line">       decodeFromRetrievedData();</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">     <span class="keyword">default</span>:</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unrecognized run reason: "</span> + runReason);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//获取任务场景</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> Stage <span class="title">getNextStage</span><span class="params">(Stage current)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">switch</span> (current) &#123;</span><br><span class="line">     <span class="keyword">case</span> INITIALIZE:</span><br><span class="line">  	<span class="comment">//若配置的缓存策略允许从资源缓存中读取数据，则返回Stage.RESOURCE_CACHE</span></span><br><span class="line">       <span class="keyword">return</span> diskCacheStrategy.decodeCachedResource()</span><br><span class="line">           ? Stage.RESOURCE_CACHE : getNextStage(Stage.RESOURCE_CACHE);</span><br><span class="line">     <span class="keyword">case</span> RESOURCE_CACHE:</span><br><span class="line">  	<span class="comment">//若配置的缓存策略允许从源数据缓存读取数据，则返回Stage.DATA_CACHE</span></span><br><span class="line">       <span class="keyword">return</span> diskCacheStrategy.decodeCachedData()</span><br><span class="line">           ? Stage.DATA_CACHE : getNextStage(Stage.DATA_CACHE);</span><br><span class="line">     <span class="keyword">case</span> DATA_CACHE:</span><br><span class="line">       <span class="comment">//若只能允许从缓存中读取数据，则直接FINISH,否则返回Stage.SOURCE，表示加载新的资源</span></span><br><span class="line">       <span class="keyword">return</span> onlyRetrieveFromCache ? Stage.FINISHED : Stage.SOURCE;</span><br><span class="line">     <span class="keyword">case</span> SOURCE:</span><br><span class="line">     <span class="keyword">case</span> FINISHED:</span><br><span class="line">       <span class="keyword">return</span> Stage.FINISHED;</span><br><span class="line">     <span class="keyword">default</span>:</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unrecognized stage: "</span> + current);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//获取这个场景的执行者</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> DataFetcherGenerator <span class="title">getNextGenerator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">switch</span> (stage) &#123;</span><br><span class="line">     <span class="keyword">case</span> RESOURCE_CACHE:</span><br><span class="line">  	<span class="comment">// 资源磁盘缓存的执行者</span></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> ResourceCacheGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">     <span class="keyword">case</span> DATA_CACHE:</span><br><span class="line">  	<span class="comment">// 源数据磁盘缓存的执行者</span></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> DataCacheGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">     <span class="keyword">case</span> SOURCE:</span><br><span class="line">  	<span class="comment">// 无缓存, 获取数据的源的执行者</span></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SourceGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">     <span class="keyword">case</span> FINISHED:</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">     <span class="keyword">default</span>:</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unrecognized stage: "</span> + stage);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runGenerators</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   currentThread = Thread.currentThread();</span><br><span class="line">   startFetchTime = LogTime.getLogTime();</span><br><span class="line">   <span class="keyword">boolean</span> isStarted = <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">// 调用 DataFetcherGenerator.startNext() 执行了请求操作</span></span><br><span class="line"><span class="comment">//我们这里主要分析的是无缓存情况，所以这里的DataFetcherGenerator应该是SourceGenerator</span></span><br><span class="line">   <span class="keyword">while</span> (!isCancelled &amp;&amp; currentGenerator != <span class="keyword">null</span></span><br><span class="line">       &amp;&amp; !(isStarted = currentGenerator.startNext())) &#123;</span><br><span class="line">     stage = getNextStage(stage);</span><br><span class="line">     currentGenerator = getNextGenerator();</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (stage == Stage.SOURCE) &#123;</span><br><span class="line">       reschedule();</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   .....</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>怎么执行任务呢？大体上可以分为三个步骤：</p>
<ol>
<li>获取任务场景</li>
<li>获取任务场景的执行者</li>
<li>执行者执行任务</li>
</ol>
<p>场景和执行者是一一对应的，由于我们现在分析的是第一次加载图片，并且没有配置缓存策略，所以对应的任务场景为无缓存情况，与之相对应的执行者就是SourceGenerator对象，所以当执行任务时调用的是SourceGenerator的startNext方法</p>
<blockquote>
<p>SourceGenerator#startNext</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">startNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">while</span> (!started &amp;&amp; hasNextModelLoader()) &#123;</span><br><span class="line"> <span class="comment">//从DecodeHelper的数据加载集合中, 获取一个数据加载器 </span></span><br><span class="line">    loadData = helper.getLoadData().get(loadDataListIndex++);</span><br><span class="line">    <span class="keyword">if</span> (loadData != <span class="keyword">null</span></span><br><span class="line">        &amp;&amp; (helper.getDiskCacheStrategy().isDataCacheable(loadData.fetcher.getDataSource())</span><br><span class="line">        || helper.hasLoadPath(loadData.fetcher.getDataClass()))) &#123;</span><br><span class="line">      started = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用加载器fetcher执行数据加载</span></span><br><span class="line"><span class="comment">//此fetcher为HttpUrlFetcher对象</span></span><br><span class="line">      loadData.fetcher.loadData(helper.getPriority(), <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> started;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="获取数据加载器"><a href="#获取数据加载器" class="headerlink" title="获取数据加载器"></a>获取数据加载器</h6><p>首先来看看如何得到数据加载器的集合</p>
<blockquote>
<p>DecodeHelper#getLoadData</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> List&lt;LoadData&lt;?&gt;&gt; getLoadData() &#123;</span><br><span class="line">   <span class="keyword">if</span> (!isLoadDataSet) &#123;</span><br><span class="line">     isLoadDataSet = <span class="keyword">true</span>;</span><br><span class="line">     loadData.clear();</span><br><span class="line">  <span class="comment">//从Glide注册的register中获取modelLoaders</span></span><br><span class="line">     List&lt;ModelLoader&lt;Object, ?&gt;&gt; modelLoaders = glideContext.getRegistry().getModelLoaders(model);</span><br><span class="line">     <span class="comment">//遍历modelLoaders</span></span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = modelLoaders.size(); i &lt; size; i++) &#123;</span><br><span class="line">       <span class="comment">//此时分析的model为url的string格式，该其中一个实现类为StringLoader </span></span><br><span class="line">       ModelLoader&lt;Object, ?&gt; modelLoader = modelLoaders.get(i);</span><br><span class="line">	<span class="comment">//通过StringLoader构造loadData</span></span><br><span class="line">	<span class="comment">//经过Glide的registry分析后最终会执行HttpGlideUrlLoader的buildLoadData方法</span></span><br><span class="line">	<span class="comment">//最终的loadData封装了HttpUrlFetcher对象</span></span><br><span class="line">       LoadData&lt;?&gt; current =</span><br><span class="line">           modelLoader.buildLoadData(model, width, height, options);</span><br><span class="line">       <span class="keyword">if</span> (current != <span class="keyword">null</span>) &#123;</span><br><span class="line">	  <span class="comment">//添加到loadData集合中</span></span><br><span class="line">         loadData.add(current);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//最终返回的是含有HttpUrlFetcher对象的loadData集合</span></span><br><span class="line">   <span class="keyword">return</span> loadData;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>我们来一步步解剖这个方法，首先需要从Glide注册的registry中获取modelLoaders，因为我们全文以String为例子，所以这里的model将是String类型的。</p>
<p><strong>！！！注意：在注册表中注册的都是ModelLoader的实现ModelLoaderFactory静态工厂类，当调用Registry的getModelLoaders时会调用工厂类中的build方法</strong>，这里就不贴出这其中的过程了，现在我们只需要知道当调用getModelLoaders方法时会调用注册表中对应工厂类的build方法。现在我们需要回头看看Glide构建时的注册表，看看model为String类型时有那些ModelLoader的静态工厂类，下面只列举几个：</p>
<blockquote>
<p>Glide#Glide构造器</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">registry</span><br><span class="line">	<span class="comment">//重点关注StringLoader.StreamFactory()</span></span><br><span class="line">       .append(String.class, InputStream.class, <span class="keyword">new</span> StringLoader.StreamFactory())</span><br><span class="line">       .append(String.class, ParcelFileDescriptor.class, <span class="keyword">new</span> StringLoader.FileDescriptorFactory())</span><br><span class="line">       .append(</span><br><span class="line">           String.class, AssetFileDescriptor.class, <span class="keyword">new</span> StringLoader.AssetFileDescriptorFactory())</span><br></pre></td></tr></table></figure>
<p>这里我们以StringLoader.StreamFactory为例子,由于调用了getModelLoaders方法，所以会执行StringLoader.StreamFactory的build方法</p>
<blockquote>
<p>StringLoader.StreamFactory()</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamFactory</span> <span class="keyword">implements</span> <span class="title">ModelLoaderFactory</span>&lt;<span class="title">String</span>, <span class="title">InputStream</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ModelLoader&lt;String, InputStream&gt; <span class="title">build</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      @NonNull MultiModelLoaderFactory multiFactory)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//从Glide的registry的models注册表可以得知</span></span><br><span class="line">    <span class="comment">//这时候的multiFactory为HttpUriLoader.Factory() </span></span><br><span class="line">    <span class="comment">//不断追踪下去得知最终参数里返回的是HttpGlideUrlLoader对象</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StringLoader&lt;&gt;(multiFactory.build(Uri.class, InputStream.class));</span><br><span class="line">  &#125;</span><br><span class="line">  .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从build方法中，构建了StringLoader对象，但是其中的参数又调用了另外一个MultiModelLoaderFactory，这时候我们需要看会Glide的注册表中，然后找到参数为Uri.class, InputStream.class时构建的MultiModelLoaderFactory对象</p>
<blockquote>
<p>Glide#Glide的构造器</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">registry       </span><br><span class="line"><span class="comment">//重点关注HttpUriLoader.Factory()</span></span><br><span class="line">      .append(Uri.class, InputStream.class, <span class="keyword">new</span> HttpUriLoader.Factory())</span><br></pre></td></tr></table></figure>
<p>可以发现这时候的MultiModelLoaderFactory对象将会是HttpUriLoader.Factory()类型的，所以我们还需要看看其中的build方法</p>
<blockquote>
<p>HttpUriLoader.Factory#build</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ModelLoader&lt;Uri, InputStream&gt; <span class="title">build</span><span class="params">(MultiModelLoaderFactory multiFactory)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//根据Glide中的registry中的Models注册表可以知道</span></span><br><span class="line">  <span class="comment">//这时候的multiFactory为HttpGlideUrlLoader.Factory()</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> HttpUriLoader(multiFactory.build(GlideUrl.class, InputStream.class));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还是跟上面一样的步骤，继续查看Glide的注册表，找出参数为GlideUrl.class, InputStream.class的MultiModelLoaderFactory对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">   registry    </span><br><span class="line"><span class="comment">//重点关注HttpGlideUrlLoader</span></span><br><span class="line">      .append(GlideUrl.class, InputStream.class, <span class="keyword">new</span> HttpGlideUrlLoader.Factory())</span><br></pre></td></tr></table></figure>
<p>再看看HttpGlideUrlLoader.Factory的build方法</p>
<blockquote>
<p>HttpGlideUrlLoader.Factory#build</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ModelLoader&lt;GlideUrl, InputStream&gt; <span class="title">build</span><span class="params">(MultiModelLoaderFactory multiFactory)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//最终返回的是HttpGlideUrlLoader对象</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> HttpGlideUrlLoader(modelCache);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的build方法返回的是HttpGlideUrlLoader类型，所以最终构建StringLoader对象中的参数将是HttpGlideUrlLoader类型的。于是我们看看StringLoader的构造器的实现。</p>
<blockquote>
<p>StringLoader#StringLoader构造器</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">StringLoader</span><span class="params">(ModelLoader&lt;Uri, Data&gt; uriLoader)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//此时的uriLoader为HttpGlideUrlLoader对象，赋值给静态成员变量</span></span><br><span class="line">  <span class="keyword">this</span>.uriLoader = uriLoader;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>构建器就是简单的给成员变量赋值，此时的uriLoader为HttpGlideUrlLoader对象。这就是getModelLoaders所做的事，我们继续分析DecodeHelper的getLoadData方法，当获取到了String的modelLoaders后会遍历每一个modelLoader，然后调用modelLoader的buildLoadData来构造loadData对象，这里我们直接用上面分析得到的StringLoader为例，让我们看看StringLoader的buildLoadData的实现</p>
<blockquote>
<p>StringLoader#buildLoadData</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> LoadData&lt;Data&gt; <span class="title">buildLoadData</span><span class="params">(@NonNull String model, <span class="keyword">int</span> width, <span class="keyword">int</span> height,</span></span></span><br><span class="line"><span class="function"><span class="params">     @NonNull Options options)</span> </span>&#123;</span><br><span class="line">   Uri uri = parseUri(model);</span><br><span class="line">   <span class="keyword">if</span> (uri == <span class="keyword">null</span> || !uriLoader.handles(uri)) &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//此时的uriLoader为HttpGlideUrlLoader对象</span></span><br><span class="line">   <span class="keyword">return</span> uriLoader.buildLoadData(uri, width, height, options);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>由上面分析我们已经知道此时StringLoader中的uriLoader为HttpGlideUrlLoader对象，所以会继续调用HttpGlideUrlLoader的buildLoadData方法</p>
<blockquote>
<p>HttpGlideUrlLoader</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> LoadData&lt;InputStream&gt; <span class="title">buildLoadData</span><span class="params">(@NonNull GlideUrl model, <span class="keyword">int</span> width, <span class="keyword">int</span> height,</span></span></span><br><span class="line"><span class="function"><span class="params">     @NonNull Options options)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// GlideUrls memoize parsed URLs so caching them saves a few object instantiations and time</span></span><br><span class="line">   <span class="comment">// spent parsing urls.</span></span><br><span class="line">   GlideUrl url = model;</span><br><span class="line">   <span class="keyword">if</span> (modelCache != <span class="keyword">null</span>) &#123;</span><br><span class="line">     url = modelCache.get(model, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">     <span class="keyword">if</span> (url == <span class="keyword">null</span>) &#123;</span><br><span class="line">       modelCache.put(model, <span class="number">0</span>, <span class="number">0</span>, model);</span><br><span class="line">       url = model;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">int</span> timeout = options.get(TIMEOUT);</span><br><span class="line"><span class="comment">//创建了一个LoadData对象, 并且封装了HttpUrlFetcher对象</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> LoadData&lt;&gt;(url, <span class="keyword">new</span> HttpUrlFetcher(url, timeout));</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>其它代码我们并不需要过多的关注，只需要关注最后的返回值，可以发现最后返回的是封装了HttpUrlFetcher的LoadData对象，这样getLoadData方法获取到的就是封装了HttpUrlFetcher的LoadData对象。让我们回到SourceGenerator的startNext方法。</p>
<blockquote>
<p>SourceGenerator#startNext</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">startNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">while</span> (!started &amp;&amp; hasNextModelLoader()) &#123;</span><br><span class="line"> <span class="comment">//最终获取的的对象就是封装了HttpUrlFetcher的LoadData对象</span></span><br><span class="line">    loadData = helper.getLoadData().get(loadDataListIndex++);</span><br><span class="line">    <span class="keyword">if</span> (loadData != <span class="keyword">null</span></span><br><span class="line">        &amp;&amp; (helper.getDiskCacheStrategy().isDataCacheable(loadData.fetcher.getDataSource())</span><br><span class="line">        || helper.hasLoadPath(loadData.fetcher.getDataClass()))) &#123;</span><br><span class="line">      started = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用加载器fetcher执行数据加载</span></span><br><span class="line"><span class="comment">//此fetcher为HttpUrlFetcher对象</span></span><br><span class="line">      loadData.fetcher.loadData(helper.getPriority(), <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> started;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面已经分析了loadData是封装了HttpUrlFetcher的LoadData对象，所以执行数据加载其实就是调用了HttpUrlFetcher的loadData方法。</p>
<h6 id="执行数据加载"><a href="#执行数据加载" class="headerlink" title="执行数据加载"></a>执行数据加载</h6><blockquote>
<p>HttpUrlFetcher#loadData</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadData</span><span class="params">(@NonNull Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">     @NonNull DataCallback&lt;? <span class="keyword">super</span> InputStream&gt; callback)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">long</span> startTime = LogTime.getLogTime();</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">//获取网络图片的输入流	</span></span><br><span class="line">     InputStream result = loadDataWithRedirects(glideUrl.toURL(), <span class="number">0</span>, <span class="keyword">null</span>, glideUrl.getHeaders());</span><br><span class="line">  <span class="comment">//将inputStream回调出去，callback为DataCallback</span></span><br><span class="line">     callback.onDataReady(result);</span><br><span class="line">   &#125;</span><br><span class="line">     ......</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">//网络请求代码，利用了HttpURLConnection进行网络请求</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> InputStream <span class="title">loadDataWithRedirects</span><span class="params">(URL url, <span class="keyword">int</span> redirects, URL lastUrl,</span></span></span><br><span class="line"><span class="function"><span class="params">     Map&lt;String, String&gt; headers)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">   ......</span><br><span class="line">   <span class="comment">//静态工厂模式创建HttpUrlConnection对象</span></span><br><span class="line">   urlConnection = connectionFactory.build(url);</span><br><span class="line">   <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; headerEntry : headers.entrySet()) &#123;</span><br><span class="line">     urlConnection.addRequestProperty(headerEntry.getKey(), headerEntry.getValue());</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//设置连接超时时间为2500ms</span></span><br><span class="line">   urlConnection.setConnectTimeout(timeout);</span><br><span class="line"><span class="comment">//设置读取超时时间为2500ms</span></span><br><span class="line">   urlConnection.setReadTimeout(timeout);</span><br><span class="line"><span class="comment">//不使用http缓存</span></span><br><span class="line">   urlConnection.setUseCaches(<span class="keyword">false</span>);</span><br><span class="line">   urlConnection.setDoInput(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Stop the urlConnection instance of HttpUrlConnection from following redirects so that</span></span><br><span class="line">   <span class="comment">// redirects will be handled by recursive calls to this method, loadDataWithRedirects.</span></span><br><span class="line">   urlConnection.setInstanceFollowRedirects(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Connect explicitly to avoid errors in decoders if connection fails.</span></span><br><span class="line">   urlConnection.connect();</span><br><span class="line">   <span class="comment">// Set the stream so that it's closed in cleanup to avoid resource leaks. See #2352.</span></span><br><span class="line">   stream = urlConnection.getInputStream();</span><br><span class="line">   <span class="keyword">if</span> (isCancelled) &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">int</span> statusCode = urlConnection.getResponseCode();</span><br><span class="line">   <span class="keyword">if</span> (isHttpOk(statusCode)) &#123;</span><br><span class="line">  <span class="comment">//请求成功</span></span><br><span class="line">     <span class="keyword">return</span> getStreamForSuccessfulRequest(urlConnection);</span><br><span class="line">   &#125; </span><br><span class="line">   ......  </span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> InputStream <span class="title">getStreamForSuccessfulRequest</span><span class="params">(HttpURLConnection urlConnection)</span></span></span><br><span class="line"><span class="function">     <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (TextUtils.isEmpty(urlConnection.getContentEncoding())) &#123;</span><br><span class="line">     <span class="keyword">int</span> contentLength = urlConnection.getContentLength();</span><br><span class="line">     stream = ContentLengthInputStream.obtain(urlConnection.getInputStream(), contentLength);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</span><br><span class="line">       Log.d(TAG, <span class="string">"Got non empty content encoding: "</span> + urlConnection.getContentEncoding());</span><br><span class="line">     &#125;</span><br><span class="line">     stream = urlConnection.getInputStream();</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//最终返回的是图片的InputStream对象，还未开始读取数据</span></span><br><span class="line">   <span class="keyword">return</span> stream;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>可以发现执行数据加载有两个工作，首先是获取数据的输入流，这里采取的是HttpURLConnection进行网络请求，最终获取到的是数据的InputStream对象，记住这时候并未开始读取数据。</p>
<h6 id="返回数据"><a href="#返回数据" class="headerlink" title="返回数据"></a>返回数据</h6><p>当获取到输入流后，还需要将这个输入流返回出去，怎么返回呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">callback.onDataReady(result);</span><br></pre></td></tr></table></figure>
<p>可以发现这里使用的是回调的方法将数据的输入流回调出去。此时callbak为DataCallback对象，根据回调的使用我们知道下一步应该要找到实现DataCallback接口的类，怎么找呢？这时候就需要往回找，调用loadData方法的是在SourceGenerator的startNext方法，所以我们首选目标就是这个SourceGenerator类</p>
<blockquote>
<p>SourceGenerator#onDataReady</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SourceGenerator</span> <span class="keyword">implements</span> <span class="title">DataFetcherGenerator</span>,</span></span><br><span class="line"><span class="class">    <span class="title">DataFetcher</span>.<span class="title">DataCallback</span>&lt;<span class="title">Object</span>&gt;,</span></span><br><span class="line"><span class="class">    <span class="title">DataFetcherGenerator</span>.<span class="title">FetcherReadyCallback</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">  ........</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataReady</span><span class="params">(Object data)</span> </span>&#123;</span><br><span class="line">    DiskCacheStrategy diskCacheStrategy = helper.getDiskCacheStrategy();</span><br><span class="line">    <span class="keyword">if</span> (data != <span class="keyword">null</span> &amp;&amp; diskCacheStrategy.isDataCacheable(loadData.fetcher.getDataSource())) &#123;</span><br><span class="line">      dataToCache = data;</span><br><span class="line">      ....</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	  <span class="comment">//继续回调FetcherReadyCallback的onDataFetcherReady方法，将data回调出去</span></span><br><span class="line">      cb.onDataFetcherReady(loadData.sourceKey, data, loadData.fetcher,</span><br><span class="line">          loadData.fetcher.getDataSource(), originalKey);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>机智如我们！果然SourceGenerator类实现了DataFetcher.DataCallback这个接口，并且在这个类找到了onDataReady方法，这个方法还是选择回调，回调了FetcherReadyCallback的onDataFetcherReady方法，于是我们在往回找，并在心中默念：在哪个类中调用了SourceGenerator的startNext方法呢？然后你就会发现是在DecodeJob的run方法中调用了startNext这个方法，然后马上看看DecodeJob是否实现了onDataFetcherReady接口！</p>
<blockquote>
<p>DecodeJob#onDataFetcherReady</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DecodeJob</span>&lt;<span class="title">R</span>&gt; <span class="keyword">implements</span> <span class="title">DataFetcherGenerator</span>.<span class="title">FetcherReadyCallback</span>,</span></span><br><span class="line"><span class="class">    <span class="title">Runnable</span>,</span></span><br><span class="line"><span class="class">    <span class="title">Comparable</span>&lt;<span class="title">DecodeJob</span>&lt;?&gt;&gt;,</span></span><br><span class="line"><span class="class">    <span class="title">Poolable</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">     .......   </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataFetcherReady</span><span class="params">(Key sourceKey, Object data, DataFetcher&lt;?&gt; fetcher,</span></span></span><br><span class="line"><span class="function"><span class="params">      DataSource dataSource, Key attemptedKey)</span> </span>&#123;</span><br><span class="line">    .......</span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != currentThread) &#123;</span><br><span class="line">      runReason = RunReason.DECODE_DATA;</span><br><span class="line">      callback.reschedule(<span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      GlideTrace.beginSection(<span class="string">"DecodeJob.decodeFromRetrievedData"</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">	  	<span class="comment">//解析获取的数据</span></span><br><span class="line">        decodeFromRetrievedData();</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        GlideTrace.endSection();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">decodeFromRetrievedData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ....</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">	  <span class="comment">//获取解析后</span></span><br><span class="line">      resource = decodeFromData(currentFetcher, currentData, currentDataSource);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (GlideException e) &#123;</span><br><span class="line">      e.setLoggingDetails(currentAttemptingKey, currentDataSource);</span><br><span class="line">      throwables.add(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (resource != <span class="keyword">null</span>) &#123;</span><br><span class="line">	  <span class="comment">//通知外界资源获取成功	</span></span><br><span class="line">      notifyEncodeAndRelease(resource, currentDataSource);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      runGenerators();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>哇！超神了！果然是这样！onDataFetcherReady方法中主要工作有两件：</p>
<ol>
<li>解析获取的数据</li>
<li>返回图片资源</li>
</ol>
<p>我们先看看是如何解析数据的</p>
<h3 id="2-5-解析数据"><a href="#2-5-解析数据" class="headerlink" title="2.5 解析数据"></a>2.5 解析数据</h3><blockquote>
<p>DecodeJob</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> &lt;Data&gt; <span class="function">Resource&lt;R&gt; <span class="title">decodeFromData</span><span class="params">(DataFetcher&lt;?&gt; fetcher, Data data,</span></span></span><br><span class="line"><span class="function"><span class="params">     DataSource dataSource)</span> <span class="keyword">throws</span> GlideException </span>&#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     ......</span><br><span class="line"></span><br><span class="line">  <span class="comment">//重点关注decodeFromFetcher方法</span></span><br><span class="line">     Resource&lt;R&gt; result = decodeFromFetcher(data, dataSource);</span><br><span class="line">     <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">       logWithTimeAndKey(<span class="string">"Decoded result "</span> + result, startTime);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> result;</span><br><span class="line">   &#125; </span><br><span class="line">   ......  </span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> &lt;Data&gt; <span class="function">Resource&lt;R&gt; <span class="title">decodeFromFetcher</span><span class="params">(Data data, DataSource dataSource)</span></span></span><br><span class="line"><span class="function">     <span class="keyword">throws</span> GlideException </span>&#123;</span><br><span class="line">   <span class="comment">//获取当前数据类的解析器LoadPath,此时的data为InputStream对象  </span></span><br><span class="line">   LoadPath&lt;Data, ?, R&gt; path = decodeHelper.getLoadPath((Class&lt;Data&gt;) data.getClass());</span><br><span class="line"><span class="comment">//通过解析器来解析数据</span></span><br><span class="line">   <span class="keyword">return</span> runLoadPath(data, dataSource, path);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> &lt;Data, ResourceType&gt; <span class="function">Resource&lt;R&gt; <span class="title">runLoadPath</span><span class="params">(Data data, DataSource dataSource,</span></span></span><br><span class="line"><span class="function"><span class="params">     LoadPath&lt;Data, ResourceType, R&gt; path)</span> <span class="keyword">throws</span> GlideException </span>&#123;</span><br><span class="line">   Options options = getOptionsWithHardwareConfig(dataSource);</span><br><span class="line"><span class="comment">//此时的data为InputStream对象，故rewinder为InputStreamRewinder对象</span></span><br><span class="line">   DataRewinder&lt;Data&gt; rewinder = glideContext.getRegistry().getRewinder(data);</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="comment">//将数据解析转移到LoadPath.load方法中</span></span><br><span class="line">     <span class="keyword">return</span> path.load(</span><br><span class="line">         rewinder, options, width, height, <span class="keyword">new</span> DecodeCallback&lt;ResourceType&gt;(dataSource));</span><br><span class="line">   &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">     rewinder.cleanup();</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这里的rewinder的获取跟modelLoaders的获取一样需要重新看Glide构建中的注册表registry，在这里不再详细说明，因为data为InputStream对象，所以rewinder为InputStreamRewinder对象，然后调用LoadPath的load方法实现解析数据</p>
<blockquote>
<p>LoadPath</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Resource&lt;Transcode&gt; <span class="title">load</span><span class="params">(DataRewinder&lt;Data&gt; rewinder, @NonNull Options options, <span class="keyword">int</span> width,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> height, DecodePath.DecodeCallback&lt;ResourceType&gt; decodeCallback)</span> <span class="keyword">throws</span> GlideException </span>&#123;</span><br><span class="line">  List&lt;Throwable&gt; throwables = Preconditions.checkNotNull(listPool.acquire());</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line"> <span class="comment">//重点关注</span></span><br><span class="line">    <span class="keyword">return</span> loadWithExceptionList(rewinder, options, width, height, decodeCallback, throwables);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    listPool.release(throwables);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Resource&lt;Transcode&gt; <span class="title">loadWithExceptionList</span><span class="params">(DataRewinder&lt;Data&gt; rewinder,</span></span></span><br><span class="line"><span class="function"><span class="params">    @NonNull Options options,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> width, <span class="keyword">int</span> height, DecodePath.DecodeCallback&lt;ResourceType&gt; decodeCallback,</span></span></span><br><span class="line"><span class="function"><span class="params">    List&lt;Throwable&gt; exceptions)</span> <span class="keyword">throws</span> GlideException </span>&#123;</span><br><span class="line">  Resource&lt;Transcode&gt; result = <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">//遍历DecodePath集合</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = decodePaths.size(); i &lt; size; i++) &#123;</span><br><span class="line">    DecodePath&lt;Data, ResourceType, Transcode&gt; path = decodePaths.get(i);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"> 	<span class="comment">//调用DecodePath.decode真正进行数据解析</span></span><br><span class="line">      result = path.decode(rewinder, width, height, options, decodeCallback);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (GlideException e) &#123;</span><br><span class="line">      exceptions.add(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> GlideException(failureMessage, <span class="keyword">new</span> ArrayList&lt;&gt;(exceptions));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>DecodePath</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> Resource&lt;Transcode&gt; <span class="title">decode</span><span class="params">(DataRewinder&lt;DataType&gt; rewinder, <span class="keyword">int</span> width, <span class="keyword">int</span> height,</span></span></span><br><span class="line"><span class="function"><span class="params">     @NonNull Options options, DecodeCallback&lt;ResourceType&gt; callback)</span> <span class="keyword">throws</span> GlideException </span>&#123;</span><br><span class="line">   <span class="comment">//获取到Resource&lt;Bitmap&gt;对象  </span></span><br><span class="line">   Resource&lt;ResourceType&gt; decoded = decodeResource(rewinder, width, height, options);</span><br><span class="line"><span class="comment">//将资源转化为目标效果，如在构建request时设置的CenterCrop</span></span><br><span class="line">   Resource&lt;ResourceType&gt; transformed = callback.onResourceDecoded(decoded);</span><br><span class="line"><span class="comment">//将数据转化为目标格式，将Resource&lt;Bitmap&gt;转换为LazyBitmapDrawableResource对象</span></span><br><span class="line"><span class="comment">//可通过LazyBitmapDrawableResource的get获取到BitmapDrawable对象</span></span><br><span class="line"><span class="comment">//该transcoder为BitmapDrawableTranscoder</span></span><br><span class="line">   <span class="keyword">return</span> transcoder.transcode(transformed, options);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>LoadPath的load方法最终会调用DecodePath的decode来解析数据，DecodePath的decode的主要工作就是获取到Resource<bitmap>对象，然后还要将Resource<bitmap>对象转化成LazyBitmapDrawableResource。考虑到篇幅问题，在这里就不分析如何得到Resource<bitmap>对象，只分析如何将数据转化为目标格式，可以通过Glide构造中的注册表中找出Bitmap转化成Drawable的转化器为BitmapDrawableTranscoder，所以实际上调用了BitmapDrawableTranscoder的transcode来进行转换</bitmap></bitmap></bitmap></p>
<blockquote>
<p>BitmapDrawableTranscoder#transcode</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Resource&lt;BitmapDrawable&gt; <span class="title">transcode</span><span class="params">(@NonNull Resource&lt;Bitmap&gt; toTranscode,</span></span></span><br><span class="line"><span class="function"><span class="params">    @NonNull Options options)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//获取LazyBitmapDrawableResource对象  </span></span><br><span class="line">  <span class="keyword">return</span> LazyBitmapDrawableResource.obtain(resources, toTranscode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>LazyBitmapDrawableResource</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Resource&lt;BitmapDrawable&gt; <span class="title">obtain</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">     @NonNull Resources resources, @Nullable Resource&lt;Bitmap&gt; bitmapResource)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (bitmapResource == <span class="keyword">null</span>) &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//创建了一个LazyBitmapDrawableResource对象</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> LazyBitmapDrawableResource(resources, bitmapResource);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">public</span> BitmapDrawable <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">//返回一个BitmapDrawable对象</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> BitmapDrawable(resources, bitmapResource.get());</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>追踪下去可以发现transcode最终会得到一个封装了Resource<bitmap>的对象，然后看LazyBitmapDrawableResource的get方法，可以得到一个BitmapDrawable对象，即目标格式。到这里就成功将数据解析成LazyBitmapDrawableResource对象。</bitmap></p>
<h3 id="2-6-在主线程中显示图片"><a href="#2-6-在主线程中显示图片" class="headerlink" title="2.6 在主线程中显示图片"></a>2.6 在主线程中显示图片</h3><p>既然解析完数据，剩下的工作就是将数据显示出来，于是我们得重新看回DecodeJob的decodeFromRetrievedData方法</p>
<blockquote>
<p>DecodeJob</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">decodeFromRetrievedData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   ....</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">//解析成功后resource为封装了Resource&lt;Bitmap&gt;的LazyBitmapDrawableResource对象</span></span><br><span class="line">     <span class="comment">//可通过get方法获取到BitmapDrawable对象</span></span><br><span class="line">     resource = decodeFromData(currentFetcher, currentData, currentDataSource);</span><br><span class="line">   &#125; <span class="keyword">catch</span> (GlideException e) &#123;</span><br><span class="line">     e.setLoggingDetails(currentAttemptingKey, currentDataSource);</span><br><span class="line">     throwables.add(e);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (resource != <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="comment">//通知外界资源获取成功	</span></span><br><span class="line">     notifyEncodeAndRelease(resource, currentDataSource);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     runGenerators();</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyEncodeAndRelease</span><span class="params">(Resource&lt;R&gt; resource, DataSource dataSource)</span> </span>&#123;</span><br><span class="line">   .....</span><br><span class="line">   <span class="comment">//重点关注</span></span><br><span class="line">   notifyComplete(result, dataSource);</span><br><span class="line">   ......</span><br><span class="line">   </span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyComplete</span><span class="params">(Resource&lt;R&gt; resource, DataSource dataSource)</span> </span>&#123;</span><br><span class="line">   setNotifiedOrThrow();</span><br><span class="line"><span class="comment">//回调，注意此时的callback为EngineJob(可回头看Engine中DecodeJob的创建)</span></span><br><span class="line">   callback.onResourceReady(resource, dataSource);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-6-1-回调数据"><a href="#2-6-1-回调数据" class="headerlink" title="2.6.1  回调数据"></a>2.6.1  回调数据</h4><p>嘻嘻，看到最后又来到了我们熟悉的回调方法，看到这个callback你可能会一脸茫然，这个callback哪个对象呢？别急，让我们来一步步分析。</p>
<p>首先先确定下这个notifyComplete是在DecodeJob类中，因此callback应该是其成员变量，然后我们得找出赋值的地方</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//重点关注倒数第二个参数，callback的类型为CallBack</span></span><br><span class="line"><span class="function">DecodeJob&lt;R&gt; <span class="title">init</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    GlideContext glideContext,</span></span></span><br><span class="line"><span class="function"><span class="params">    Object model,</span></span></span><br><span class="line"><span class="function"><span class="params">    EngineKey loadKey,</span></span></span><br><span class="line"><span class="function"><span class="params">    Key signature,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> width,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> height,</span></span></span><br><span class="line"><span class="function"><span class="params">    Class&lt;?&gt; resourceClass,</span></span></span><br><span class="line"><span class="function"><span class="params">    Class&lt;R&gt; transcodeClass,</span></span></span><br><span class="line"><span class="function"><span class="params">    Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">    DiskCacheStrategy diskCacheStrategy,</span></span></span><br><span class="line"><span class="function"><span class="params">    Map&lt;Class&lt;?&gt;, Transformation&lt;?&gt;&gt; transformations,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> isTransformationRequired,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> isScaleOnlyOrNoTransform,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> onlyRetrieveFromCache,</span></span></span><br><span class="line"><span class="function"><span class="params">    Options options,</span></span></span><br><span class="line"><span class="function"><span class="params">    Callback&lt;R&gt; callback,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> order)</span> </span>&#123;</span><br><span class="line">  decodeHelper.init(</span><br><span class="line">      glideContext,</span><br><span class="line">      model,</span><br><span class="line">      signature,</span><br><span class="line">      width,</span><br><span class="line">      height,</span><br><span class="line">      diskCacheStrategy,</span><br><span class="line">      resourceClass,</span><br><span class="line">      transcodeClass,</span><br><span class="line">      priority,</span><br><span class="line">      options,</span><br><span class="line">      transformations,</span><br><span class="line">      isTransformationRequired,</span><br><span class="line">      isScaleOnlyOrNoTransform,</span><br><span class="line">      diskCacheProvider);</span><br><span class="line">  <span class="keyword">this</span>.glideContext = glideContext;</span><br><span class="line">  <span class="keyword">this</span>.signature = signature;</span><br><span class="line">  <span class="keyword">this</span>.priority = priority;</span><br><span class="line">  <span class="keyword">this</span>.loadKey = loadKey;</span><br><span class="line">  <span class="keyword">this</span>.width = width;</span><br><span class="line">  <span class="keyword">this</span>.height = height;</span><br><span class="line">  <span class="keyword">this</span>.diskCacheStrategy = diskCacheStrategy;</span><br><span class="line">  <span class="keyword">this</span>.onlyRetrieveFromCache = onlyRetrieveFromCache;</span><br><span class="line">  <span class="keyword">this</span>.options = options;</span><br><span class="line">  <span class="keyword">this</span>.callback = callback;</span><br><span class="line">  <span class="keyword">this</span>.order = order;</span><br><span class="line">  <span class="keyword">this</span>.runReason = RunReason.INITIALIZE;</span><br><span class="line">  <span class="keyword">this</span>.model = model;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很容易的我们发现在init方法会为callback赋值，这时候得记住callback参数的具体位置为倒数第二个。这时候你会想：哪里会调用DecodeJob的init方法呢？然后揣摩：既然是赋值估计会在构建DecodeJob时候会调用到。于是问题就转换为：上文是在哪个地方构建了DecodeJob？然后心里默念：DecodeJob是用来执行任务的，所以应该在构建任务的时候会调用！（不过大多数的情形是：脑子里一片空白，压根想不出来，反正笔者在这里就想不出来。所以这时候就可以直接往上找到DecodeJob首次出现的位置），最终是会在Engine的load中找到DecodeJob的构建</p>
<blockquote>
<p>Engine#load</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> &lt;R&gt; <span class="function">LoadStatus <span class="title">load</span><span class="params">(....)</span></span>&#123;</span><br><span class="line">    <span class="comment">//重点关注倒数最后一个参数</span></span><br><span class="line">	DecodeJob&lt;R&gt; decodeJob =</span><br><span class="line">        decodeJobFactory.build(</span><br><span class="line">            glideContext,</span><br><span class="line">            model,</span><br><span class="line">            key,</span><br><span class="line">            signature,</span><br><span class="line">            width,</span><br><span class="line">            height,</span><br><span class="line">            resourceClass,</span><br><span class="line">            transcodeClass,</span><br><span class="line">            priority,</span><br><span class="line">            diskCacheStrategy,</span><br><span class="line">            transformations,</span><br><span class="line">            isTransformationRequired,</span><br><span class="line">            isScaleOnlyOrNoTransform,</span><br><span class="line">            onlyRetrieveFromCache,</span><br><span class="line">            options,</span><br><span class="line">            engineJob);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">//重点关注最后一个参数</span></span><br><span class="line">    &lt;R&gt; <span class="function">DecodeJob&lt;R&gt; <span class="title">build</span><span class="params">(GlideContext glideContext,</span></span></span><br><span class="line"><span class="function"><span class="params">        Object model,</span></span></span><br><span class="line"><span class="function"><span class="params">        EngineKey loadKey,</span></span></span><br><span class="line"><span class="function"><span class="params">        Key signature,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> width,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> height,</span></span></span><br><span class="line"><span class="function"><span class="params">        Class&lt;?&gt; resourceClass,</span></span></span><br><span class="line"><span class="function"><span class="params">        Class&lt;R&gt; transcodeClass,</span></span></span><br><span class="line"><span class="function"><span class="params">        Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">        DiskCacheStrategy diskCacheStrategy,</span></span></span><br><span class="line"><span class="function"><span class="params">        Map&lt;Class&lt;?&gt;, Transformation&lt;?&gt;&gt; transformations,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> isTransformationRequired,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> isScaleOnlyOrNoTransform,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> onlyRetrieveFromCache,</span></span></span><br><span class="line"><span class="function"><span class="params">        Options options,</span></span></span><br><span class="line"><span class="function"><span class="params">        DecodeJob.Callback&lt;R&gt; callback)</span> </span>&#123;</span><br><span class="line">      DecodeJob&lt;R&gt; result = Preconditions.checkNotNull((DecodeJob&lt;R&gt;) pool.acquire());</span><br><span class="line">      <span class="keyword">return</span> result.init(</span><br><span class="line">          glideContext,</span><br><span class="line">          model,</span><br><span class="line">          loadKey,</span><br><span class="line">          signature,</span><br><span class="line">          width,</span><br><span class="line">          height,</span><br><span class="line">          resourceClass,</span><br><span class="line">          transcodeClass,</span><br><span class="line">          priority,</span><br><span class="line">          diskCacheStrategy,</span><br><span class="line">          transformations,</span><br><span class="line">          isTransformationRequired,</span><br><span class="line">          isScaleOnlyOrNoTransform,</span><br><span class="line">          onlyRetrieveFromCache,</span><br><span class="line">          options,</span><br><span class="line">          callback,</span><br><span class="line">          creationOrder++);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>在上面的代码中首先调用了DecodeJobFactory的build方法来构建DecodeJob,DecodeJobFactory是Engine的内部类，然后接着看DecodeJobFactory的build方法，哇！跟我们想的完全一样！build方法中调用了DecodeJob的init方法，找到后可别忘了我们的任务是干嘛的！找到callback的值，于是看回build的callback的参数位置，在最后一个，然后往回看Engine的load中调用build的最后一个参数！<strong>engineJob</strong>！没错最后找到的callback的类型应该是EngineJob类型的，其实EngineJob是实现了DecodeJob.Callback接口的。所以接下来就会回调EngineJob的onResourceReady方法</p>
<blockquote>
<p>EngineJob#onResourceReady</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(Resource&lt;R&gt; resource, DataSource dataSource)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">     <span class="keyword">this</span>.resource = resource;</span><br><span class="line">     <span class="keyword">this</span>.dataSource = dataSource;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//重点关注</span></span><br><span class="line">   notifyCallbacksOfResult();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">notifyCallbacksOfResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   ResourceCallbacksAndExecutors copy;</span><br><span class="line">   Key localKey;</span><br><span class="line">   EngineResource&lt;?&gt; localResource;</span><br><span class="line">   <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">     ......</span><br><span class="line"></span><br><span class="line">  <span class="comment">//重点关注cbs的类型</span></span><br><span class="line">  <span class="comment">//查找cbs里面的类型</span></span><br><span class="line">     copy = cbs.copy();</span><br><span class="line">     .....</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//通知上层Engine的任务完成了</span></span><br><span class="line">   listener.onEngineJobComplete(<span class="keyword">this</span>, localKey, localResource);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">final</span> ResourceCallbackAndExecutor entry : copy) &#123;</span><br><span class="line">  <span class="comment">//回调给ImageViewTarget来展示资源</span></span><br><span class="line">     entry.executor.execute(<span class="keyword">new</span> CallResourceReady(entry.cb));</span><br><span class="line">   &#125;</span><br><span class="line">   decrementPendingCallbacks();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-6-2-回到主线程"><a href="#2-6-2-回到主线程" class="headerlink" title="2.6.2 回到主线程"></a>2.6.2 回到主线程</h4><p>又到了确定参数类型的时刻了，赶紧召唤福尔摩斯上线！首先我们先确定EngineJob的onResourceReady方法中最重要的代码片</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">final</span> ResourceCallbackAndExecutor entry : copy) &#123;</span><br><span class="line">  <span class="comment">//回调给ImageViewTarget来展示资源</span></span><br><span class="line">     entry.executor.execute(<span class="keyword">new</span> CallResourceReady(entry.cb));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>在确定分析线程池的execute的方法前，我们需要做的事有：</p>
<ul>
<li>确定entry.executor类型</li>
<li>确定entry.cb类型</li>
</ul>
<p>现在我们知道entry为ResourceCallbackAndExecutor方法,所以我们来看看这个类以及构造器</p>
<blockquote>
<p>ResourceCallbackAndExecutor</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceCallbackAndExecutor</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> ResourceCallback cb;</span><br><span class="line">  <span class="keyword">final</span> Executor executor;</span><br><span class="line"></span><br><span class="line">  ResourceCallbackAndExecutor(ResourceCallback cb, Executor executor) &#123;</span><br><span class="line">    <span class="keyword">this</span>.cb = cb;</span><br><span class="line">    <span class="keyword">this</span>.executor = executor;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以发现executor和cb都是ResourceCallbackAndExecutor中的成员变量，在构造时被赋值，所以我们需要找到构造ResourceCallbackAndExecutor对象的地方，自然而然我们会锁定上面copy这个变量</p>
<blockquote>
<p>EngineJob</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="keyword">final</span> ResourceCallbacksAndExecutors cbs = <span class="keyword">new</span> ResourceCallbacksAndExecutors();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notifyCallbacksOfResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ResourceCallbacksAndExecutors copy;</span><br><span class="line">    Key localKey;</span><br><span class="line">    EngineResource&lt;?&gt; localResource;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">      ......</span><br><span class="line"></span><br><span class="line">	  <span class="comment">//重点关注cbs的类型</span></span><br><span class="line">	  <span class="comment">//查找cbs里面的类型</span></span><br><span class="line">      copy = cbs.copy();</span><br><span class="line">      .....</span><br><span class="line">    &#125;</span><br><span class="line">    .....</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">ResourceCallbacksAndExecutors <span class="title">copy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ResourceCallbacksAndExecutors(<span class="keyword">new</span> ArrayList&lt;&gt;(callbacksAndExecutors));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     </span><br><span class="line">    <span class="comment">//cbs赋值的地方</span></span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">addCallback</span><span class="params">(<span class="keyword">final</span> ResourceCallback cb, Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">    stateVerifier.throwIfRecycled();</span><br><span class="line">	<span class="comment">//此时的cb为singleRequest类型，其实现了ResourceCallback接口</span></span><br><span class="line">	<span class="comment">//callbackExecutor就是绑定了主线程Handler的线程池</span></span><br><span class="line">	<span class="comment">//cbs的类型为ResourceCallbacksAndExecutors</span></span><br><span class="line">	<span class="comment">//add的内部实现就是创建ResourceCallbacksAndExecutor并将cb,callbackExecutor赋值到其成员变量</span></span><br><span class="line">    <span class="comment">//然后再add到cbs中    </span></span><br><span class="line">    cbs.add(cb, callbackExecutor);</span><br><span class="line">    ......</span><br><span class="line">     </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(ResourceCallback cb, Executor executor)</span> </span>&#123;</span><br><span class="line">      callbacksAndExecutors.add(<span class="keyword">new</span> ResourceCallbackAndExecutor(cb, executor));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>让我们看看copy赋值调用的地方，就是调用了ResourceCallbacksAndExecutors类型的cbs的copy方法，copy其实就是创建了ResourceCallbacksAndExecutor集合，这个集合其实就是cbs，我们还需要找到cbs赋值的地方，找半天后你会发现在addCallback方法中会找到cbs的add方法，add方法的内部实现其实就是创建ResourceCallbacksAndExecutor并将cb,callbackExecutor赋值到其成员变量中，所以我们还得确定add方法的两个参数是什么？不知道你是否还有印象，当初在构建任务时我们有专门提到过这个addCallback方法，让我们重新看看Engine的load方法。</p>
<blockquote>
<p>Engine#load</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   ....</span><br><span class="line">   <span class="comment">//调用addCallback()注册了一个ResourceCallback</span></span><br><span class="line"><span class="comment">//这里的cb是load方法的倒数第二个参数，load是在singleRequest的onSizeReady()调用的</span></span><br><span class="line"><span class="comment">//查看后cb为singleRequest类型</span></span><br><span class="line"><span class="comment">//重新看回EngineJob的addCallback方法</span></span><br><span class="line">   engineJob.addCallback(cb, callbackExecutor);</span><br><span class="line"><span class="comment">//在子线程中执行DecodeJob的run方法</span></span><br><span class="line">   engineJob.start(decodeJob);</span><br></pre></td></tr></table></figure>
<p>要想确定cb和callbackExecutor的类型，我们还需要一步一步往回走</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//特别关注最后两个参数</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> &lt;R&gt; <span class="function">LoadStatus <span class="title">load</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    GlideContext glideContext,</span></span></span><br><span class="line"><span class="function"><span class="params">    Object model,</span></span></span><br><span class="line"><span class="function"><span class="params">    Key signature,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> width,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> height,</span></span></span><br><span class="line"><span class="function"><span class="params">    Class&lt;?&gt; resourceClass,</span></span></span><br><span class="line"><span class="function"><span class="params">    Class&lt;R&gt; transcodeClass,</span></span></span><br><span class="line"><span class="function"><span class="params">    Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">    DiskCacheStrategy diskCacheStrategy,</span></span></span><br><span class="line"><span class="function"><span class="params">    Map&lt;Class&lt;?&gt;, Transformation&lt;?&gt;&gt; transformations,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> isTransformationRequired,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> isScaleOnlyOrNoTransform,</span></span></span><br><span class="line"><span class="function"><span class="params">    Options options,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> isMemoryCacheable,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> useUnlimitedSourceExecutorPool,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> useAnimationPool,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> onlyRetrieveFromCache,</span></span></span><br><span class="line"><span class="function"><span class="params">    ResourceCallback cb,</span></span></span><br><span class="line"><span class="function"><span class="params">    Executor callbackExecutor)</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>SingleRequest#onSizeReady</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">loadStatus =</span><br><span class="line">	<span class="comment">//重点关注倒数第二个参数，传入的是this，即SingleRequest对象，其实现了ResourceCallback接口</span></span><br><span class="line">	<span class="comment">//重点关注倒数第一个参数，传入有绑定主线程的Handle的r线程池callbackExectuter</span></span><br><span class="line">    engine.load(</span><br><span class="line">        glideContext,</span><br><span class="line">        model,</span><br><span class="line">        requestOptions.getSignature(),</span><br><span class="line">        <span class="keyword">this</span>.width,</span><br><span class="line">        <span class="keyword">this</span>.height,</span><br><span class="line">        requestOptions.getResourceClass(),</span><br><span class="line">        transcodeClass,</span><br><span class="line">        priority,</span><br><span class="line">        requestOptions.getDiskCacheStrategy(),</span><br><span class="line">        requestOptions.getTransformations(),</span><br><span class="line">        requestOptions.isTransformationRequired(),</span><br><span class="line">        requestOptions.isScaleOnlyOrNoTransform(),</span><br><span class="line">        requestOptions.getOptions(),</span><br><span class="line">        requestOptions.isMemoryCacheable(),</span><br><span class="line">        requestOptions.getUseUnlimitedSourceGeneratorsPool(),</span><br><span class="line">        requestOptions.getUseAnimationPool(),</span><br><span class="line">        requestOptions.getOnlyRetrieveFromCache(),</span><br><span class="line">        <span class="keyword">this</span>,</span><br><span class="line">        callbackExecutor);</span><br></pre></td></tr></table></figure>
<p>SingleRequest的onSizeReady中我们确定了cb的类型为SingleRequest对象，另外一个参数的话由于篇幅原因就不一一贴出代码了（都是上文贴过的代码），你可以直接从onSizeReady方法往回看，上面的注释也会提到，最后你会发现这个callbackExecutor其实就是我们一开始提到的含有绑定主线程Handler的线程池。让我们回到最初的地方</p>
<blockquote>
<p>EngineJob#onResourceReady</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">final</span> ResourceCallbackAndExecutor entry : copy) &#123;</span><br><span class="line">  <span class="comment">//回调给ImageViewTarget来展示资源</span></span><br><span class="line">      <span class="comment">//entry.cb为singleRequest类型类型</span></span><br><span class="line">   <span class="comment">//entry.executor就是含有绑定了主线程的Handler的线程池,即MAIN_THREAD_EXECUTOR</span></span><br><span class="line">     entry.executor.execute(<span class="keyword">new</span> CallResourceReady(entry.cb));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>所以我们来看看Executors的mainThreadExecutor方法（忘记的重新看上面的2.2）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor MAIN_THREAD_EXECUTOR =</span><br><span class="line">      <span class="keyword">new</span> Executor() &#123;</span><br><span class="line">       <span class="comment">//绑定主线程的Looper</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Handler handler = <span class="keyword">new</span> Handler(Looper.getMainLooper());</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(@NonNull Runnable command)</span> </span>&#123;  </span><br><span class="line">          handler.post(command);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Executor <span class="title">mainThreadExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> MAIN_THREAD_EXECUTOR;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>根据Handler机制的相关知识，当调用MAIN_THREAD_EXECUTOR的execute方法后将会在主线程中执行CallResourceReady对象的run方法。所以我们看看CallResourceReady的run方法</p>
<h4 id="2-6-3-显示图片"><a href="#2-6-3-显示图片" class="headerlink" title="2.6.3 显示图片"></a>2.6.3 显示图片</h4><blockquote>
<p>EngineJob.CallResourceReady#run</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (EngineJob.<span class="keyword">this</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (cbs.contains(cb)) &#123;</span><br><span class="line">        <span class="comment">// Acquire for this particular callback.</span></span><br><span class="line">        engineResource.acquire();</span><br><span class="line">  <span class="comment">//重点关注，此时cb为SingleRequest对象</span></span><br><span class="line">        callCallbackOnResourceReady(cb);</span><br><span class="line">        removeCallback(cb);</span><br><span class="line">      &#125;</span><br><span class="line">      decrementPendingCallbacks();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">callCallbackOnResourceReady</span><span class="params">(ResourceCallback cb)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//回调，将目标数据回调出去</span></span><br><span class="line">    <span class="comment">//此时的cb为singleRequest类型</span></span><br><span class="line">    cb.onResourceReady(engineResource, dataSource);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> CallbackException(t);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到这是不是很开心（实际头皮发麻）！又来到了我们熟悉的回调了，此时的cb是SingleRequest类型，我们已经在上文分析过了。所以会调用SingleRequest的onResourceReady方法</p>
<blockquote>
<p>SingleRequest#onResourceReady</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(Resource&lt;?&gt; resource, DataSource dataSource)</span> </span>&#123;</span><br><span class="line">  .......</span><br><span class="line">  <span class="comment">//重点关注</span></span><br><span class="line">  onResourceReady((Resource&lt;R&gt;) resource, (R) received, dataSource);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(Resource&lt;R&gt; resource, R result, DataSource dataSource)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//第一次加载</span></span><br><span class="line">  <span class="keyword">boolean</span> isFirstResource = isFirstReadyResource();</span><br><span class="line">  status = Status.COMPLETE;</span><br><span class="line">  <span class="keyword">this</span>.resource = resource;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (glideContext.getLogLevel() &lt;= Log.DEBUG) &#123;</span><br><span class="line">    Log.d(GLIDE_TAG, <span class="string">"Finished loading "</span> + result.getClass().getSimpleName() + <span class="string">" from "</span></span><br><span class="line">        + dataSource + <span class="string">" for "</span> + model + <span class="string">" with size ["</span> + width + <span class="string">"x"</span> + height + <span class="string">"] in "</span></span><br><span class="line">        + LogTime.getElapsedMillis(startTime) + <span class="string">" ms"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  isCallingCallbacks = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">boolean</span> anyListenerHandledUpdatingTarget = <span class="keyword">false</span>;</span><br><span class="line"> <span class="comment">//如果在使用时设置listener的话，就会回调其中的onResourceReady</span></span><br><span class="line">    <span class="keyword">if</span> (requestListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (RequestListener&lt;R&gt; listener : requestListeners) &#123;</span><br><span class="line">        anyListenerHandledUpdatingTarget |=</span><br><span class="line">            listener.onResourceReady(result, model, target, dataSource, isFirstResource);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    anyListenerHandledUpdatingTarget |=</span><br><span class="line">        targetListener != <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; targetListener.onResourceReady(result, model, target, dataSource, isFirstResource);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!anyListenerHandledUpdatingTarget) &#123;</span><br><span class="line">      Transition&lt;? <span class="keyword">super</span> R&gt; animation =</span><br><span class="line">          animationFactory.build(dataSource, isFirstResource);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//展示照片</span></span><br><span class="line">   <span class="comment">//此时的target为DrawableImageViewTarget</span></span><br><span class="line">      target.onResourceReady(result, animation);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    isCallingCallbacks = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//通知加载成功</span></span><br><span class="line">  notifyLoadSuccess();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们只需要关注target.onResourceReady(result, animation)这句代码，target对象为DrawableImageViewTarget，所以会调用DrawableImageViewTarget的onResourceReady方法,但是因为DrawableImageViewTarget是没有onResourceReady这个方法的，所以应该是在其父类ImageViewTarget中</p>
<blockquote>
<p>ImageViewTarget</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(@NonNull Z resource, @Nullable Transition&lt;? <span class="keyword">super</span> Z&gt; transition)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//是否有动画效果 </span></span><br><span class="line">  <span class="keyword">if</span> (transition == <span class="keyword">null</span> || !transition.transition(resource, <span class="keyword">this</span>)) &#123;</span><br><span class="line"> <span class="comment">//重点关注，静态图	</span></span><br><span class="line">    setResourceInternal(resource);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//gif  </span></span><br><span class="line">    maybeUpdateAnimatable(resource);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setResourceInternal</span><span class="params">(@Nullable Z resource)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//调用setResource来展示照片</span></span><br><span class="line">  setResource(resource);</span><br><span class="line">  maybeUpdateAnimatable(resource);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//此方法为抽象方法，由子类实现，由于分析的是静态图，故实现的子类应该为DrawableImageViewTarget</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setResource</span><span class="params">(@Nullable Z resource)</span></span>;</span><br></pre></td></tr></table></figure>
<p>这里我们以正常的静态图为例子，所以接下来会调用setResourceInternal(resource)方法，然后继续调用setResource(resource)方法来展示图片，setResource在ImageViewTarget为抽象方法，所以我们继续看回子类DrawableImageViewTarget的实现</p>
<blockquote>
<p>DrawableImageViewTarget#setResource</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setResource</span><span class="params">(@Nullable Drawable resource)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//成功展示照片</span></span><br><span class="line">  view.setImageDrawable(resource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>哇！看到这里眼泪估计又要流下来了，没错setResource很简单，就是直接将照片显示出来！</p>
<h2 id="3-小结-2"><a href="#3-小结-2" class="headerlink" title="3. 小结"></a>3. 小结</h2><p>into方法算的上是整个Glide图片加载流程中逻辑最复杂的一部曲了，代码量多，相对应的工作量也是超级多的，既当爹又当妈，既要网络获取数据，又要解析并显示数据。整理后其主要工作如下图：</p>
<p><img src="/2019/10/18/Glide-4-9源码解析-图片加载流程/into.png" alt=""></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>Glide源码阅读还是花了很长时间，首先阅读了几篇Glide3.x版本的文章和Glide3.7的源码，然后又阅读了Glide4.9的文章和源码，最后再自己总结。阅读完Glide4.9加载流程的源码给我的感受就是这回调是真的多，而且找回调的参数还挺费时间的。不过整体而言，内心只有一句话，“Glide牛逼！”，用起来只有一行代码，实际内部处理逻辑是多么的复杂以及到位,也足以见得Glide的功能有多强大了。</p>
<blockquote>
<p>参考博客：</p>
<ul>
<li><a href="https://juejin.im/post/5ca5c7f7e51d45430235ba03#heading-27" target="_blank" rel="noopener">Glide 4.9 源码分析（一） —— 一次完整加载流程</a></li>
<li><a href="https://blog.csdn.net/carson_ho/article/details/79212841" target="_blank" rel="noopener">Android源码分析：这是一份详细的图片加载库Glide源码讲解攻略</a></li>
<li><a href="https://blog.csdn.net/guolin_blog/article/details/53939176" target="_blank" rel="noopener">Android图片加载框架最全解析（二），从源码的角度理解Glide的执行流程</a></li>
</ul>
</blockquote>

      
    </div>

    

    
    
    


    <div>
      
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>
      
    </div>

    


    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/拆轮子系列/" rel="tag"><i class="fa fa-tag"></i> 拆轮子系列</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/10/10/Android自定义View-简约风歌词控件/" rel="next" title="Android自定义View-简约风歌词控件">
                <i class="fa fa-chevron-left"></i> Android自定义View-简约风歌词控件
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/uploads/avatar.jpg" alt="袁健策">
            
              <p class="site-author-name" itemprop="name">袁健策</p>
              <p class="site-description motion-element" itemprop="description">在校大学生，Android小白，正在努力学习中！</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">24</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">16</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/jsyjst" title="GitHub &rarr; https://github.com/jsyjst" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="/y8588130@163.com" title="E-Mail &rarr; y8588130@163.com"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://blog.csdn.net/qq_41979349" title="CSDN &rarr; https://blog.csdn.net/qq_41979349" rel="noopener" target="_blank"><i class="fa fa-fw fa-copyright"></i>CSDN</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://juejin.im/user/5d9d42b9e51d4577fc7b1c3d/posts" title="掘金 &rarr; https://juejin.im/user/5d9d42b9e51d4577fc7b1c3d/posts" rel="noopener" target="_blank"><i class="fa fa-fw fa-heartbeat"></i>掘金</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#一、with"><span class="nav-text">一、with</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-作用"><span class="nav-text">1. 作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-流程"><span class="nav-text">2. 流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-时序图"><span class="nav-text">2.1 时序图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-获取RequestManagerRetriever对象"><span class="nav-text">2.2 获取RequestManagerRetriever对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-获取RequestManager对象"><span class="nav-text">2.3 获取RequestManager对象</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1-获取到Application类型的RequestManager对象"><span class="nav-text">2.3.1 获取到Application类型的RequestManager对象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-获取到非Application类型的RequestManager对象"><span class="nav-text">2.3.2 获取到非Application类型的RequestManager对象</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-小结"><span class="nav-text">3. 小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二、load"><span class="nav-text">二、load</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-作用-1"><span class="nav-text">1. 作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-流程-1"><span class="nav-text">2. 流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-时序图-1"><span class="nav-text">2.1 时序图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-创建RequestBuilder对象"><span class="nav-text">2.2 创建RequestBuilder对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-传入图片URL地址"><span class="nav-text">2.3 传入图片URL地址</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-小结-1"><span class="nav-text">3. 小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三、into"><span class="nav-text">三、into</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-作用-2"><span class="nav-text">1. 作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-流程-2"><span class="nav-text">2. 流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-创建ViewTarget对象"><span class="nav-text">2.1 创建ViewTarget对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-创建MAIN-THREAD-EXECUTOR"><span class="nav-text">2.2 创建MAIN_THREAD_EXECUTOR</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-构建网络请求对象Request"><span class="nav-text">2.3 构建网络请求对象Request</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-执行网络请求对象Request"><span class="nav-text">2.4 执行网络请求对象Request</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-1-加载前"><span class="nav-text">2.4.1 加载前</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-2-加载时"><span class="nav-text">2.4.2 加载时</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-onLoadFailed"><span class="nav-text">1. onLoadFailed</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-onLoadStarted"><span class="nav-text">2. onLoadStarted</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-onSizeReady"><span class="nav-text">3. onSizeReady</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#构建任务"><span class="nav-text">构建任务</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#执行任务"><span class="nav-text">执行任务</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#获取数据加载器"><span class="nav-text">获取数据加载器</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#执行数据加载"><span class="nav-text">执行数据加载</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#返回数据"><span class="nav-text">返回数据</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-解析数据"><span class="nav-text">2.5 解析数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-在主线程中显示图片"><span class="nav-text">2.6 在主线程中显示图片</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-1-回调数据"><span class="nav-text">2.6.1  回调数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-2-回到主线程"><span class="nav-text">2.6.2 回到主线程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-3-显示图片"><span class="nav-text">2.6.3 显示图片</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-小结-2"><span class="nav-text">3. 小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">袁健策</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.0.0</div>



<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共76.6k字</span>
</div>
        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
    
  
  <script color="0,0,0" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>



  
  











  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script src="/lib/three/three.min.js"></script>

  
  <script src="/lib/three/three-waves.min.js"></script>


  


  <script src="/js/src/utils.js?v=7.0.0"></script>

  <script src="/js/src/motion.js?v=7.0.0"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.0"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.0"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.0"></script>
<script src="/js/src/post-details.js?v=7.0.0"></script>



  


  <script src="/js/src/bootstrap.js?v=7.0.0"></script>



  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
